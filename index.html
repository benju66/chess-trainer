<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Chess Opening Trainer</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 50%, #1e293b 100%);
            min-height: 100vh;
            color: #e2e8f0;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
            padding: 16px;
            padding-bottom: 100px;
        }

        /* Header */
        .header {
            text-align: center;
            padding: 20px 0;
        }

        .header h1 {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .header p {
            color: #94a3b8;
            font-size: 0.875rem;
        }

        /* Menu */
        .section-title {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: #64748b;
            margin-top: 16px;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .edit-mode-toggle {
            font-size: 0.7rem;
            background: rgba(251, 191, 36, 0.1);
            border: 1px solid rgba(251, 191, 36, 0.3);
            color: #fbbf24;
            padding: 4px 10px;
            border-radius: 12px;
            cursor: pointer;
            text-transform: none;
            letter-spacing: normal;
        }

        .edit-mode-toggle.active {
            background: rgba(251, 191, 36, 0.2);
            border-color: #fbbf24;
        }

        .opening-card {
            background: rgba(51, 65, 85, 0.5);
            border: 1px solid #334155;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }

        .opening-card:hover, .opening-card:active {
            background: rgba(71, 85, 105, 0.5);
            border-color: #475569;
            transform: scale(1.02);
        }

        .opening-card h3 {
            font-size: 1.125rem;
            margin-bottom: 4px;
            padding-right: 70px;
        }

        .opening-card p {
            color: #94a3b8;
            font-size: 0.875rem;
        }

        .opening-card .moves {
            font-family: monospace;
            color: #fbbf24;
            font-size: 0.8rem;
            margin-top: 8px;
        }

        .color-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: 600;
            margin-left: 8px;
        }

        .color-badge.white {
            background: #fbbf24;
            color: #1e293b;
        }

        .color-badge.black {
            background: #475569;
            color: #e2e8f0;
        }

        .card-actions {
            position: absolute;
            top: 12px;
            right: 12px;
            display: none;
            gap: 6px;
        }

        .card-actions.visible {
            display: flex;
        }

        .card-action-btn {
            background: rgba(71, 85, 105, 0.8);
            border: none;
            color: #cbd5e1;
            width: 28px;
            height: 28px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .card-action-btn:hover {
            background: rgba(100, 116, 139, 0.9);
        }

        .card-action-btn.delete:hover {
            background: rgba(239, 68, 68, 0.4);
            color: #f87171;
        }

        /* Screens */
        .screen {
            display: none;
        }

        .screen.active {
            display: block;
        }

        /* Back Button */
        .back-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            background: none;
            border: none;
            color: #94a3b8;
            font-size: 0.875rem;
            cursor: pointer;
            padding: 8px 0;
            margin-bottom: 16px;
        }

        .back-btn:hover {
            color: #e2e8f0;
        }

        /* Move History */
        .move-history {
            background: rgba(30, 41, 59, 0.5);
            border: 1px solid #334155;
            border-radius: 12px;
            padding: 12px;
            margin-bottom: 16px;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        .move-history-inner {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
        }

        .move-tag {
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 0.8rem;
            font-family: monospace;
            white-space: nowrap;
        }

        .move-tag.white-move {
            background: rgba(251, 191, 36, 0.2);
            color: #fbbf24;
        }

        .move-tag.black-move {
            background: rgba(71, 85, 105, 0.5);
            color: #cbd5e1;
        }

        .move-tag.choice {
            border: 1px solid #fbbf24;
        }

        /* Current Move Card */
        .current-move-card {
            background: #334155;
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 16px;
        }

        .move-label {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 12px;
        }

        .move-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }

        .move-dot.your-move {
            background: #fbbf24;
            box-shadow: 0 0 12px rgba(251, 191, 36, 0.4);
        }

        .move-dot.opponent-move {
            background: #64748b;
        }

        .move-label span {
            font-weight: 600;
            font-size: 0.875rem;
        }

        .move-label span.your-move {
            color: #fbbf24;
        }

        .move-label span.opponent-move {
            color: #94a3b8;
        }

        .current-move {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
        }

        .current-move.opponent {
            background: linear-gradient(135deg, #475569 0%, #334155 100%);
        }

        .current-move h2 {
            font-family: monospace;
            font-size: 1.5rem;
            color: #1e293b;
        }

        .current-move.opponent h2 {
            color: #e2e8f0;
        }

        .explanation {
            color: #cbd5e1;
            font-size: 1rem;
            line-height: 1.5;
        }

        /* Options */
        .options-section {
            margin-top: 20px;
        }

        .options-label {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 12px;
            color: #94a3b8;
            font-size: 0.875rem;
            font-weight: 600;
        }

        .option-btn {
            width: 100%;
            background: rgba(51, 65, 85, 0.5);
            border: 1px solid #475569;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: left;
            color: #e2e8f0;
        }

        .option-btn:hover, .option-btn:active {
            background: rgba(71, 85, 105, 0.6);
            border-color: #64748b;
            transform: scale(1.01);
        }

        .option-btn .move-text {
            font-family: monospace;
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .option-btn .label {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.7rem;
            margin-left: 8px;
            background: #475569;
        }

        .option-btn .label.main {
            background: rgba(16, 185, 129, 0.2);
            color: #34d399;
        }

        .option-btn .label.blunder {
            background: rgba(239, 68, 68, 0.2);
            color: #f87171;
        }

        .option-btn .arrow {
            float: right;
            color: #64748b;
            font-size: 1.5rem;
        }

        /* Choice Cards */
        .choices-grid {
            display: grid;
            gap: 12px;
        }

        .choice-card {
            background: rgba(51, 65, 85, 0.3);
            border: 2px solid;
            border-radius: 12px;
            padding: 16px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: left;
        }

        .choice-card:hover, .choice-card:active {
            transform: scale(1.02);
        }

        .choice-card.red { border-color: rgba(239, 68, 68, 0.5); }
        .choice-card.red:hover { border-color: #ef4444; background: rgba(239, 68, 68, 0.1); }
        .choice-card.blue { border-color: rgba(59, 130, 246, 0.5); }
        .choice-card.blue:hover { border-color: #3b82f6; background: rgba(59, 130, 246, 0.1); }
        .choice-card.purple { border-color: rgba(168, 85, 247, 0.5); }
        .choice-card.purple:hover { border-color: #a855f7; background: rgba(168, 85, 247, 0.1); }
        .choice-card.green { border-color: rgba(34, 197, 94, 0.5); }
        .choice-card.green:hover { border-color: #22c55e; background: rgba(34, 197, 94, 0.1); }

        .choice-card h4 {
            font-family: monospace;
            font-size: 1.125rem;
            margin-bottom: 4px;
        }

        .choice-card.red h4 { color: #f87171; }
        .choice-card.blue h4 { color: #60a5fa; }
        .choice-card.purple h4 { color: #c084fc; }
        .choice-card.green h4 { color: #4ade80; }

        .choice-card .name {
            font-weight: 600;
            font-size: 0.875rem;
            margin-bottom: 4px;
        }

        .choice-card.red .name { color: #fca5a5; }
        .choice-card.blue .name { color: #93c5fd; }
        .choice-card.purple .name { color: #d8b4fe; }
        .choice-card.green .name { color: #86efac; }

        .choice-card .style {
            font-size: 0.75rem;
            color: #94a3b8;
        }

        /* End Card */
        .end-card {
            text-align: center;
            padding: 32px 16px;
        }

        .end-card .icon {
            font-size: 3rem;
            margin-bottom: 16px;
        }

        .end-card h3 {
            font-size: 1.25rem;
            margin-bottom: 8px;
        }

        .end-card p {
            color: #94a3b8;
        }

        /* Controls */
        .controls {
            display: flex;
            gap: 12px;
            margin-top: 20px;
        }

        .control-btn {
            flex: 1;
            padding: 14px;
            border: none;
            border-radius: 10px;
            font-size: 0.875rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .control-btn.secondary {
            background: #475569;
            color: #e2e8f0;
        }

        .control-btn.secondary:hover {
            background: #64748b;
        }

        /* Progress Dots */
        .progress-dots {
            display: flex;
            justify-content: center;
            gap: 4px;
            margin-top: 20px;
        }

        .progress-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #334155;
            transition: background 0.3s;
        }

        .progress-dot.active {
            background: #fbbf24;
        }

        /* Tip Box */
        .tip-box {
            background: rgba(30, 41, 59, 0.5);
            border: 1px solid #334155;
            border-radius: 10px;
            padding: 12px;
            margin-top: 20px;
            font-size: 0.8rem;
            color: #94a3b8;
            text-align: center;
        }

        /* Buttons */
        .btn-row {
            display: flex;
            gap: 12px;
            margin-top: 16px;
        }

        .btn {
            flex: 1;
            padding: 16px;
            border-radius: 12px;
            font-size: 0.875rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
            border: none;
        }

        .btn-primary {
            background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: scale(1.02);
        }

        .btn-secondary {
            background: rgba(71, 85, 105, 0.5);
            border: 1px solid #475569;
            color: #e2e8f0;
        }

        .btn-secondary:hover {
            background: rgba(71, 85, 105, 0.8);
        }

        /* Builder */
        .builder-section {
            background: rgba(30, 41, 59, 0.5);
            border: 1px solid #334155;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
        }

        .builder-section h3 {
            font-size: 0.875rem;
            color: #94a3b8;
            margin-bottom: 12px;
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-group label {
            display: block;
            font-size: 0.8rem;
            color: #94a3b8;
            margin-bottom: 6px;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 12px;
            background: #1e293b;
            border: 1px solid #334155;
            border-radius: 8px;
            color: #e2e8f0;
            font-size: 1rem;
        }

        .form-group input:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #fbbf24;
        }

        .color-toggle {
            display: flex;
            gap: 12px;
        }

        .color-option {
            flex: 1;
            padding: 12px;
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
        }

        .color-option.white {
            background: rgba(251, 191, 36, 0.1);
            border: 2px solid rgba(251, 191, 36, 0.3);
            color: #fbbf24;
        }

        .color-option.white.selected {
            background: rgba(251, 191, 36, 0.2);
            border-color: #fbbf24;
        }

        .color-option.black {
            background: rgba(100, 116, 139, 0.1);
            border: 2px solid rgba(100, 116, 139, 0.3);
            color: #94a3b8;
        }

        .color-option.black.selected {
            background: rgba(100, 116, 139, 0.2);
            border-color: #94a3b8;
        }

        .move-list {
            background: #1e293b;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 12px;
            min-height: 80px;
            max-height: 250px;
            overflow-y: auto;
        }

        .move-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px;
            background: rgba(51, 65, 85, 0.5);
            border-radius: 6px;
            margin-bottom: 8px;
        }

        .move-item:last-child {
            margin-bottom: 0;
        }

        .move-item .move-number {
            color: #64748b;
            font-size: 0.8rem;
            min-width: 24px;
        }

        .move-item .move-notation {
            font-family: monospace;
            font-weight: 600;
            flex: 1;
        }

        .move-item .move-notation.white { color: #fbbf24; }
        .move-item .move-notation.black { color: #cbd5e1; }

        .move-item .delete-move {
            background: none;
            border: none;
            color: #64748b;
            cursor: pointer;
            padding: 4px 8px;
            font-size: 1rem;
        }

        .move-item .delete-move:hover {
            color: #f87171;
        }

        .add-move-form {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .add-move-form input {
            flex: 1;
            min-width: 80px;
            padding: 10px;
            background: #1e293b;
            border: 1px solid #334155;
            border-radius: 6px;
            color: #e2e8f0;
            font-family: monospace;
        }

        .add-move-form .explanation-input {
            flex: 2;
            min-width: 120px;
            font-family: inherit;
        }

        .add-move-form button {
            padding: 10px 16px;
            background: #22c55e;
            border: none;
            border-radius: 6px;
            color: white;
            font-weight: 600;
            cursor: pointer;
        }

        .help-text {
            font-size: 0.75rem;
            color: #64748b;
            margin-top: 8px;
        }

        .tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
        }

        .tab {
            flex: 1;
            padding: 12px;
            background: rgba(51, 65, 85, 0.3);
            border: 1px solid #334155;
            border-radius: 8px;
            color: #94a3b8;
            font-weight: 600;
            cursor: pointer;
            text-align: center;
        }

        .tab.active {
            background: rgba(251, 191, 36, 0.1);
            border-color: #fbbf24;
            color: #fbbf24;
        }

        .json-preview {
            background: #0f172a;
            border-radius: 8px;
            padding: 12px;
            font-family: monospace;
            font-size: 0.7rem;
            overflow-x: auto;
            white-space: pre-wrap;
            word-break: break-all;
            max-height: 200px;
            overflow-y: auto;
        }

        .copy-btn {
            margin-top: 8px;
            padding: 8px 16px;
            background: #475569;
            border: none;
            border-radius: 6px;
            color: white;
            cursor: pointer;
            font-size: 0.8rem;
        }

        /* Reset confirmation */
        .reset-bar {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.3);
            border-radius: 8px;
            padding: 12px;
            margin-top: 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.8rem;
        }

        .reset-bar button {
            padding: 6px 12px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.8rem;
        }

        .reset-bar .reset-confirm {
            background: #ef4444;
            color: white;
        }

        .reset-bar .reset-cancel {
            background: #475569;
            color: white;
            margin-left: 8px;
        }

        @media (min-width: 640px) {
            .header h1 { font-size: 2rem; }
            .choices-grid { grid-template-columns: repeat(3, 1fr); }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Menu Screen -->
        <div class="screen active" id="menuScreen">
            <div class="header">
                <h1>‚ôüÔ∏è Opening Trainer</h1>
                <p>Master your chess openings move by move</p>
            </div>

            <div id="openingsContainer"></div>

            <div class="btn-row">
                <button class="btn btn-primary" onclick="showBuilder()">+ Create Opening</button>
            </div>

            <div class="reset-bar" id="resetBar" style="display: none;">
                <span>Reset all openings to defaults?</span>
                <div>
                    <button class="reset-confirm" onclick="resetToDefaults()">Reset</button>
                    <button class="reset-cancel" onclick="hideResetBar()">Cancel</button>
                </div>
            </div>
        </div>

        <!-- Trainer Screen -->
        <div class="screen" id="trainerScreen">
            <button class="back-btn" onclick="goToMenu()">‚Üê Back to Openings</button>

            <div class="header">
                <h1 id="openingTitle">Italian Game</h1>
                <p id="openingSubtitle">Playing as White</p>
            </div>

            <div class="move-history">
                <div class="move-history-inner" id="moveHistory"></div>
            </div>

            <div class="current-move-card" id="currentMoveCard"></div>

            <div class="controls" id="controls"></div>

            <div class="progress-dots" id="progressDots"></div>

            <div class="tip-box">
                <span>üí°</span>
                <span id="tipText">Click on moves to explore the line</span>
            </div>
        </div>

        <!-- Builder Screen -->
        <div class="screen" id="builderScreen">
            <button class="back-btn" onclick="goToMenu()">‚Üê Back to Openings</button>

            <div class="header">
                <h1>üõ†Ô∏è Opening Builder</h1>
                <p id="builderSubtitle">Create your own opening repertoire</p>
            </div>

            <div class="tabs">
                <button class="tab active" onclick="switchTab('visual')" id="tabVisual">Visual Builder</button>
                <button class="tab" onclick="switchTab('json')" id="tabJson">Import/Export</button>
            </div>

            <div id="visualBuilder">
                <div class="builder-section">
                    <h3>Opening Info</h3>
                    <div class="form-group">
                        <label>Opening Name</label>
                        <input type="text" id="openingName" placeholder="e.g., Ruy Lopez">
                    </div>
                    <div class="form-group">
                        <label>Description</label>
                        <input type="text" id="openingDesc" placeholder="e.g., Classical Spanish opening">
                    </div>
                    <div class="form-group">
                        <label>You Play As</label>
                        <div class="color-toggle">
                            <div class="color-option white selected" onclick="setBuilderColor('white')">‚ôî White</div>
                            <div class="color-option black" onclick="setBuilderColor('black')">‚ôö Black</div>
                        </div>
                    </div>
                </div>

                <div class="builder-section">
                    <h3>Build the Line</h3>
                    <div class="move-list" id="moveList">
                        <p style="color: #64748b; text-align: center; padding: 16px;">Add moves below</p>
                    </div>

                    <div class="add-move-form">
                        <input type="text" id="newMove" placeholder="e4, Nf3...">
                        <input type="text" id="newExplanation" class="explanation-input" placeholder="Explanation">
                        <button onclick="addBuilderMove()">Add</button>
                    </div>
                    <p class="help-text">Use standard notation: e4, Nf3, O-O, Qxd5, etc.</p>
                </div>

                <div class="btn-row">
                    <button class="btn btn-secondary" onclick="previewOpening()">üëÅÔ∏è Preview</button>
                    <button class="btn btn-primary" onclick="saveOpening()">üíæ Save</button>
                </div>
            </div>

            <div id="jsonBuilder" style="display: none;">
                <div class="builder-section">
                    <h3>Import Opening (JSON)</h3>
                    <div class="form-group">
                        <textarea id="jsonInput" rows="6" placeholder='Paste JSON here...'></textarea>
                    </div>
                    <button class="btn btn-primary" onclick="importJson()" style="width: 100%;">Import</button>
                </div>

                <div class="builder-section">
                    <h3>Export Current Build</h3>
                    <div class="json-preview" id="jsonPreview">// Create moves first</div>
                    <button class="copy-btn" onclick="copyJson()">üìã Copy JSON</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ============================================================
        // FULL OPENING DATA WITH DEEP LINES
        // ============================================================
        
        const DEFAULT_OPENINGS = {
            italian_game: {
                name: "Italian Game",
                color: "white",
                description: "Classic 1.e4 opening targeting f7 with deep lines",
                startingMoves: "1. e4 e5 2. Nf3 Nc6 3. Bc4",
                tree: {
                    id: 'start',
                    move: '1. e4',
                    player: 'white',
                    explanation: 'King\'s Pawn opening. Wait for Black\'s response...',
                    children: [
                        {
                            id: 'e5',
                            move: '1... e5',
                            player: 'black',
                            label: 'Classical',
                            response: {
                                id: 'Nf3',
                                move: '2. Nf3',
                                player: 'white',
                                explanation: 'Attack the e5 pawn and develop toward the Italian!',
                                children: [
                                    {
                                        id: 'Nc6',
                                        move: '2... Nc6',
                                        player: 'black',
                                        label: 'Main Line',
                                        response: {
                                            id: 'Bc4',
                                            move: '3. Bc4',
                                            player: 'white',
                                            explanation: 'The Italian Game begins! Your bishop targets f7.',
                                            children: [
                                                // GIUOCO PIANO
                                                {
                                                    id: 'Bc5',
                                                    move: '3... Bc5',
                                                    player: 'black',
                                                    label: 'Giuoco Piano',
                                                    response: {
                                                        id: 'c3',
                                                        move: '4. c3',
                                                        player: 'white',
                                                        explanation: 'Prepare to push d4 and build a powerful center!',
                                                        children: [
                                                            {
                                                                id: 'Nf6_gp',
                                                                move: '4... Nf6',
                                                                player: 'black',
                                                                label: 'Main Line',
                                                                response: {
                                                                    id: 'd4',
                                                                    move: '5. d4',
                                                                    player: 'white',
                                                                    explanation: 'Strike the center! This is the critical moment.',
                                                                    children: [
                                                                        {
                                                                            id: 'exd4',
                                                                            move: '5... exd4',
                                                                            player: 'black',
                                                                            label: 'Main',
                                                                            response: {
                                                                                id: 'cxd4',
                                                                                move: '6. cxd4',
                                                                                player: 'white',
                                                                                explanation: 'Perfect e4+d4 center! Black usually checks.',
                                                                                children: [
                                                                                    {
                                                                                        id: 'Bb4+',
                                                                                        move: '6... Bb4+',
                                                                                        player: 'black',
                                                                                        label: 'Main',
                                                                                        response: {
                                                                                            id: 'choice_greco',
                                                                                            move: 'Choose Your Path',
                                                                                            player: 'white',
                                                                                            explanation: 'Critical decision point!',
                                                                                            isChoice: true,
                                                                                            choices: [
                                                                                                {
                                                                                                    id: 'Nc3',
                                                                                                    move: '7. Nc3',
                                                                                                    name: 'Greco Attack',
                                                                                                    style: 'Gambit e4 pawn for attack',
                                                                                                    color: 'red',
                                                                                                    explanation: 'Sacrifice e4 for rapid development!',
                                                                                                    children: [
                                                                                                        {
                                                                                                            id: 'Nxe4_greco',
                                                                                                            move: '7... Nxe4',
                                                                                                            player: 'black',
                                                                                                            label: 'Accept',
                                                                                                            response: {
                                                                                                                id: 'O-O_greco',
                                                                                                                move: '8. O-O',
                                                                                                                player: 'white',
                                                                                                                explanation: 'Castle into the attack!',
                                                                                                                children: [
                                                                                                                    {
                                                                                                                        id: 'Nxc3',
                                                                                                                        move: '8... Nxc3',
                                                                                                                        player: 'black',
                                                                                                                        label: 'Takes',
                                                                                                                        response: {
                                                                                                                            id: 'bxc3',
                                                                                                                            move: '9. bxc3',
                                                                                                                            player: 'white',
                                                                                                                            explanation: 'Open b-file! Threat is Ba3.',
                                                                                                                            children: [
                                                                                                                                {
                                                                                                                                    id: 'Bxc3',
                                                                                                                                    move: '9... Bxc3',
                                                                                                                                    player: 'black',
                                                                                                                                    label: 'Greedy',
                                                                                                                                    response: {
                                                                                                                                        id: 'Qb3',
                                                                                                                                        move: '10. Qb3',
                                                                                                                                        player: 'white',
                                                                                                                                        explanation: 'Attack f7 and b7! Crushing.',
                                                                                                                                        children: [
                                                                                                                                            {
                                                                                                                                                id: 'Bxa1',
                                                                                                                                                move: '10... Bxa1',
                                                                                                                                                player: 'black',
                                                                                                                                                label: 'Takes Rook',
                                                                                                                                                response: {
                                                                                                                                                    id: 'Bxf7+',
                                                                                                                                                    move: '11. Bxf7+ Kf8 12. Bg5',
                                                                                                                                                    player: 'white',
                                                                                                                                                    explanation: 'üî• Devastating attack! Black is lost.',
                                                                                                                                                    children: []
                                                                                                                                                }
                                                                                                                                            }
                                                                                                                                        ]
                                                                                                                                    }
                                                                                                                                },
                                                                                                                                {
                                                                                                                                    id: 'Be7',
                                                                                                                                    move: '9... Be7',
                                                                                                                                    player: 'black',
                                                                                                                                    label: 'Safe',
                                                                                                                                    response: {
                                                                                                                                        id: 'Ba3',
                                                                                                                                        move: '10. Ba3',
                                                                                                                                        player: 'white',
                                                                                                                                        explanation: 'Prevent castling!',
                                                                                                                                        children: []
                                                                                                                                    }
                                                                                                                                }
                                                                                                                            ]
                                                                                                                        }
                                                                                                                    },
                                                                                                                    {
                                                                                                                        id: 'Bxc3',
                                                                                                                        move: '8... Bxc3',
                                                                                                                        player: 'black',
                                                                                                                        label: 'Takes',
                                                                                                                        response: {
                                                                                                                            id: 'd5',
                                                                                                                            move: '9. d5!',
                                                                                                                            player: 'white',
                                                                                                                            explanation: 'Attack the knight!',
                                                                                                                            children: [
                                                                                                                                {
                                                                                                                                    id: 'Bf6',
                                                                                                                                    move: '9... Bf6',
                                                                                                                                    player: 'black',
                                                                                                                                    label: 'Retreat',
                                                                                                                                    response: {
                                                                                                                                        id: 'Re1',
                                                                                                                                        move: '10. Re1',
                                                                                                                                        player: 'white',
                                                                                                                                        explanation: 'Pin! Massive pressure.',
                                                                                                                                        children: []
                                                                                                                                    }
                                                                                                                                }
                                                                                                                            ]
                                                                                                                        }
                                                                                                                    }
                                                                                                                ]
                                                                                                            }
                                                                                                        }
                                                                                                    ]
                                                                                                },
                                                                                                {
                                                                                                    id: 'Bd2',
                                                                                                    move: '7. Bd2',
                                                                                                    name: 'Main Line',
                                                                                                    style: 'Solid approach',
                                                                                                    color: 'blue',
                                                                                                    explanation: 'Block and trade. Quieter.',
                                                                                                    children: [
                                                                                                        {
                                                                                                            id: 'Bxd2',
                                                                                                            move: '7... Bxd2+',
                                                                                                            player: 'black',
                                                                                                            label: 'Trade',
                                                                                                            response: {
                                                                                                                id: 'Nbxd2',
                                                                                                                move: '8. Nbxd2',
                                                                                                                player: 'white',
                                                                                                                explanation: 'Develop toward center.',
                                                                                                                children: [
                                                                                                                    {
                                                                                                                        id: 'd5_main',
                                                                                                                        move: '8... d5',
                                                                                                                        player: 'black',
                                                                                                                        label: 'Central',
                                                                                                                        response: {
                                                                                                                            id: 'exd5',
                                                                                                                            move: '9. exd5 Nxd5 10. O-O',
                                                                                                                            player: 'white',
                                                                                                                            explanation: 'Balanced Italian middlegame.',
                                                                                                                            children: []
                                                                                                                        }
                                                                                                                    }
                                                                                                                ]
                                                                                                            }
                                                                                                        }
                                                                                                    ]
                                                                                                },
                                                                                                {
                                                                                                    id: 'Kf1',
                                                                                                    move: '7. Kf1',
                                                                                                    name: 'M√∏ller Attack',
                                                                                                    style: 'Give up castling',
                                                                                                    color: 'purple',
                                                                                                    explanation: 'Rare but tricky!',
                                                                                                    children: []
                                                                                                }
                                                                                            ]
                                                                                        }
                                                                                    },
                                                                                    {
                                                                                        id: 'Bb6',
                                                                                        move: '6... Bb6',
                                                                                        player: 'black',
                                                                                        label: 'Retreat',
                                                                                        response: {
                                                                                            id: 'e5',
                                                                                            move: '7. e5',
                                                                                            player: 'white',
                                                                                            explanation: 'Push! Attack the knight.',
                                                                                            children: []
                                                                                        }
                                                                                    }
                                                                                ]
                                                                            }
                                                                        },
                                                                        {
                                                                            id: 'Bb6_5',
                                                                            move: '5... Bb6',
                                                                            player: 'black',
                                                                            label: 'Retreat',
                                                                            response: {
                                                                                id: 'dxe5',
                                                                                move: '6. dxe5',
                                                                                player: 'white',
                                                                                explanation: 'Win the pawn!',
                                                                                children: []
                                                                            }
                                                                        }
                                                                    ]
                                                                }
                                                            }
                                                        ]
                                                    }
                                                },
                                                // TWO KNIGHTS DEFENSE
                                                {
                                                    id: 'Nf6_tk',
                                                    move: '3... Nf6',
                                                    player: 'black',
                                                    label: 'Two Knights',
                                                    response: {
                                                        id: 'choice_tk',
                                                        move: 'Choose Your Style',
                                                        player: 'white',
                                                        explanation: 'Three main approaches:',
                                                        isChoice: true,
                                                        choices: [
                                                            {
                                                                id: 'Ng5',
                                                                move: '4. Ng5',
                                                                name: 'Fried Liver Attack',
                                                                style: 'Aggressive - Attack f7',
                                                                color: 'red',
                                                                explanation: 'Attack f7 immediately!',
                                                                children: [
                                                                    {
                                                                        id: 'd5',
                                                                        move: '4... d5',
                                                                        player: 'black',
                                                                        label: 'Main',
                                                                        response: {
                                                                            id: 'exd5',
                                                                            move: '5. exd5',
                                                                            player: 'white',
                                                                            explanation: 'Take! Critical decision for Black...',
                                                                            children: [
                                                                                {
                                                                                    id: 'Nxd5',
                                                                                    move: '5... Nxd5??',
                                                                                    player: 'black',
                                                                                    label: 'BLUNDER!',
                                                                                    response: {
                                                                                        id: 'Nxf7',
                                                                                        move: '6. Nxf7!',
                                                                                        player: 'white',
                                                                                        explanation: 'üî• THE FRIED LIVER!',
                                                                                        children: [
                                                                                            {
                                                                                                id: 'Kxf7',
                                                                                                move: '6... Kxf7',
                                                                                                player: 'black',
                                                                                                label: 'Forced',
                                                                                                response: {
                                                                                                    id: 'Qf3+',
                                                                                                    move: '7. Qf3+',
                                                                                                    player: 'white',
                                                                                                    explanation: 'Fork King and Knight!',
                                                                                                    children: [
                                                                                                        {
                                                                                                            id: 'Ke6',
                                                                                                            move: '7... Ke6',
                                                                                                            player: 'black',
                                                                                                            label: 'Only',
                                                                                                            response: {
                                                                                                                id: 'Nc3_fl',
                                                                                                                move: '8. Nc3',
                                                                                                                player: 'white',
                                                                                                                explanation: 'Attack the knight!',
                                                                                                                children: [
                                                                                                                    {
                                                                                                                        id: 'Ncb4',
                                                                                                                        move: '8... Ncb4',
                                                                                                                        player: 'black',
                                                                                                                        label: 'Escape Try',
                                                                                                                        response: {
                                                                                                                            id: 'Qe4+',
                                                                                                                            move: '9. Qe4+',
                                                                                                                            player: 'white',
                                                                                                                            explanation: 'Keep checking!',
                                                                                                                            children: [
                                                                                                                                {
                                                                                                                                    id: 'Kd6',
                                                                                                                                    move: '9... Kd6',
                                                                                                                                    player: 'black',
                                                                                                                                    label: 'Run',
                                                                                                                                    response: {
                                                                                                                                        id: 'a3',
                                                                                                                                        move: '10. a3',
                                                                                                                                        player: 'white',
                                                                                                                                        explanation: 'Win material!',
                                                                                                                                        children: []
                                                                                                                                    }
                                                                                                                                }
                                                                                                                            ]
                                                                                                                        }
                                                                                                                    }
                                                                                                                ]
                                                                                                            }
                                                                                                        }
                                                                                                    ]
                                                                                                }
                                                                                            }
                                                                                        ]
                                                                                    }
                                                                                },
                                                                                {
                                                                                    id: 'Na5',
                                                                                    move: '5... Na5',
                                                                                    player: 'black',
                                                                                    label: 'Correct',
                                                                                    response: {
                                                                                        id: 'Bb5+',
                                                                                        move: '6. Bb5+',
                                                                                        player: 'white',
                                                                                        explanation: 'Check! Main theory.',
                                                                                        children: [
                                                                                            {
                                                                                                id: 'c6',
                                                                                                move: '6... c6',
                                                                                                player: 'black',
                                                                                                label: 'Block',
                                                                                                response: {
                                                                                                    id: 'dxc6',
                                                                                                    move: '7. dxc6 bxc6 8. Be2',
                                                                                                    player: 'white',
                                                                                                    explanation: 'Complex middlegame.',
                                                                                                    children: []
                                                                                                }
                                                                                            }
                                                                                        ]
                                                                                    }
                                                                                },
                                                                                {
                                                                                    id: 'b5',
                                                                                    move: '5... b5',
                                                                                    player: 'black',
                                                                                    label: 'Ulvestad',
                                                                                    response: {
                                                                                        id: 'Bf1',
                                                                                        move: '6. Bf1',
                                                                                        player: 'white',
                                                                                        explanation: 'Sharp theory!',
                                                                                        children: []
                                                                                    }
                                                                                }
                                                                            ]
                                                                        }
                                                                    },
                                                                    {
                                                                        id: 'Bc5_trax',
                                                                        move: '4... Bc5',
                                                                        player: 'black',
                                                                        label: 'Traxler!',
                                                                        response: {
                                                                            id: 'Nxf7_trax',
                                                                            move: '5. Nxf7',
                                                                            player: 'white',
                                                                            explanation: 'Take anyway! You\'re winning.',
                                                                            children: [
                                                                                {
                                                                                    id: 'Bxf2',
                                                                                    move: '5... Bxf2+',
                                                                                    player: 'black',
                                                                                    label: 'Counter',
                                                                                    response: {
                                                                                        id: 'Kf1_trax',
                                                                                        move: '6. Kf1',
                                                                                        player: 'white',
                                                                                        explanation: 'Step aside! You\'re up material.',
                                                                                        children: []
                                                                                    }
                                                                                }
                                                                            ]
                                                                        }
                                                                    }
                                                                ]
                                                            },
                                                            {
                                                                id: 'd3',
                                                                move: '4. d3',
                                                                name: 'Giuoco Pianissimo',
                                                                style: 'Solid - Slow buildup',
                                                                color: 'blue',
                                                                explanation: 'Very quiet game.',
                                                                children: [
                                                                    {
                                                                        id: 'Bc5_p',
                                                                        move: '4... Bc5',
                                                                        player: 'black',
                                                                        label: 'Natural',
                                                                        response: {
                                                                            id: 'c3_p',
                                                                            move: '5. c3',
                                                                            player: 'white',
                                                                            explanation: 'Prepare d4 slowly.',
                                                                            children: [
                                                                                {
                                                                                    id: 'O-O_p',
                                                                                    move: '5... O-O',
                                                                                    player: 'black',
                                                                                    label: 'Castle',
                                                                                    response: {
                                                                                        id: 'O-O_pw',
                                                                                        move: '6. O-O',
                                                                                        player: 'white',
                                                                                        explanation: 'Castle too. Nbd2 next.',
                                                                                        children: [
                                                                                            {
                                                                                                id: 'd6_pp',
                                                                                                move: '6... d6',
                                                                                                player: 'black',
                                                                                                label: 'Solid',
                                                                                                response: {
                                                                                                    id: 'Nbd2',
                                                                                                    move: '7. Nbd2',
                                                                                                    player: 'white',
                                                                                                    explanation: 'Slow expansion plan.',
                                                                                                    children: []
                                                                                                }
                                                                                            }
                                                                                        ]
                                                                                    }
                                                                                }
                                                                            ]
                                                                        }
                                                                    }
                                                                ]
                                                            },
                                                            {
                                                                id: 'O-O',
                                                                move: '4. O-O',
                                                                name: 'Modern Italian',
                                                                style: 'Flexible',
                                                                color: 'purple',
                                                                explanation: 'Castle first, decide later.',
                                                                children: [
                                                                    {
                                                                        id: 'Bc5_m',
                                                                        move: '4... Bc5',
                                                                        player: 'black',
                                                                        label: 'Natural',
                                                                        response: {
                                                                            id: 'c3_m',
                                                                            move: '5. c3',
                                                                            player: 'white',
                                                                            explanation: 'Transpose to main lines.',
                                                                            children: []
                                                                        }
                                                                    },
                                                                    {
                                                                        id: 'Nxe4_m',
                                                                        move: '4... Nxe4',
                                                                        player: 'black',
                                                                        label: 'Grab Pawn',
                                                                        response: {
                                                                            id: 'd4_m',
                                                                            move: '5. d4',
                                                                            player: 'white',
                                                                            explanation: 'Open up! Win it back.',
                                                                            children: []
                                                                        }
                                                                    }
                                                                ]
                                                            }
                                                        ]
                                                    }
                                                },
                                                // HUNGARIAN
                                                {
                                                    id: 'Be7',
                                                    move: '3... Be7',
                                                    player: 'black',
                                                    label: 'Hungarian',
                                                    response: {
                                                        id: 'd4_h',
                                                        move: '4. d4',
                                                        player: 'white',
                                                        explanation: 'Seize space immediately!',
                                                        children: []
                                                    }
                                                }
                                            ]
                                        }
                                    },
                                    // PETROFF
                                    {
                                        id: 'Nf6_pet',
                                        move: '2... Nf6',
                                        player: 'black',
                                        label: 'Petroff',
                                        response: {
                                            id: 'Nxe5_pet',
                                            move: '3. Nxe5',
                                            player: 'white',
                                            explanation: 'Grab the pawn safely!',
                                            children: [
                                                {
                                                    id: 'd6_pet',
                                                    move: '3... d6',
                                                    player: 'black',
                                                    label: 'Main',
                                                    response: {
                                                        id: 'Nf3_pet',
                                                        move: '4. Nf3',
                                                        player: 'white',
                                                        explanation: 'Retreat. Now d4, Bd3.',
                                                        children: []
                                                    }
                                                }
                                            ]
                                        }
                                    },
                                    // PHILIDOR
                                    {
                                        id: 'd6_phi',
                                        move: '2... d6',
                                        player: 'black',
                                        label: 'Philidor',
                                        response: {
                                            id: 'd4_phi',
                                            move: '3. d4',
                                            player: 'white',
                                            explanation: 'Open the center!',
                                            children: []
                                        }
                                    }
                                ]
                            }
                        },
                        // Other responses to 1.e4
                        {
                            id: 'c5',
                            move: '1... c5',
                            player: 'black',
                            label: 'Sicilian',
                            response: {
                                id: 'Nf3_sic',
                                move: '2. Nf3',
                                player: 'white',
                                explanation: 'Open Sicilian.',
                                children: [
                                    {
                                        id: 'd6_sic',
                                        move: '2... d6',
                                        player: 'black',
                                        label: 'Main',
                                        response: {
                                            id: 'd4_sic',
                                            move: '3. d4 cxd4 4. Nxd4',
                                            player: 'white',
                                            explanation: 'Rich positions!',
                                            children: []
                                        }
                                    }
                                ]
                            }
                        },
                        {
                            id: 'e6',
                            move: '1... e6',
                            player: 'black',
                            label: 'French',
                            response: {
                                id: 'd4_fr',
                                move: '2. d4',
                                player: 'white',
                                explanation: 'Build center.',
                                children: [
                                    {
                                        id: 'd5_fr',
                                        move: '2... d5',
                                        player: 'black',
                                        label: 'Main',
                                        response: {
                                            id: 'exd5_fr',
                                            move: '3. exd5 exd5',
                                            player: 'white',
                                            explanation: 'Exchange French.',
                                            children: []
                                        }
                                    }
                                ]
                            }
                        },
                        {
                            id: 'c6',
                            move: '1... c6',
                            player: 'black',
                            label: 'Caro-Kann',
                            response: {
                                id: 'd4_ck',
                                move: '2. d4',
                                player: 'white',
                                explanation: 'Strong center.',
                                children: [
                                    {
                                        id: 'd5_ck',
                                        move: '2... d5',
                                        player: 'black',
                                        label: 'Main',
                                        response: {
                                            id: 'exd5_ck',
                                            move: '3. exd5 cxd5',
                                            player: 'white',
                                            explanation: 'Exchange Caro.',
                                            children: []
                                        }
                                    }
                                ]
                            }
                        },
                        {
                            id: 'd5_sc',
                            move: '1... d5',
                            player: 'black',
                            label: 'Scandinavian',
                            response: {
                                id: 'exd5_sc',
                                move: '2. exd5',
                                player: 'white',
                                explanation: 'Win time!',
                                children: [
                                    {
                                        id: 'Qxd5',
                                        move: '2... Qxd5',
                                        player: 'black',
                                        label: 'Queen',
                                        response: {
                                            id: 'Nc3_sc',
                                            move: '3. Nc3',
                                            player: 'white',
                                            explanation: 'Attack the Queen!',
                                            children: []
                                        }
                                    }
                                ]
                            }
                        }
                    ]
                }
            },

            london_system: {
                name: "London System",
                color: "white",
                description: "Solid d4 system with Bf4",
                startingMoves: "1. d4 d5 2. Bf4",
                tree: {
                    id: 'start',
                    move: '1. d4',
                    player: 'white',
                    explanation: 'Queen\'s Pawn opening.',
                    children: [
                        {
                            id: 'd5',
                            move: '1... d5',
                            player: 'black',
                            label: 'Main',
                            response: {
                                id: 'Bf4',
                                move: '2. Bf4',
                                player: 'white',
                                explanation: 'The London! Bf4 before e3.',
                                children: [
                                    {
                                        id: 'Nf6',
                                        move: '2... Nf6',
                                        player: 'black',
                                        label: 'Natural',
                                        response: {
                                            id: 'e3',
                                            move: '3. e3',
                                            player: 'white',
                                            explanation: 'Solid pyramid.',
                                            children: [
                                                {
                                                    id: 'c5',
                                                    move: '3... c5',
                                                    player: 'black',
                                                    label: 'Active',
                                                    response: {
                                                        id: 'c3',
                                                        move: '4. c3',
                                                        player: 'white',
                                                        explanation: 'Support d4.',
                                                        children: [
                                                            {
                                                                id: 'Nc6',
                                                                move: '4... Nc6',
                                                                player: 'black',
                                                                label: 'Develop',
                                                                response: {
                                                                    id: 'Nd2',
                                                                    move: '5. Nd2',
                                                                    player: 'white',
                                                                    explanation: 'Flexible development.',
                                                                    children: []
                                                                }
                                                            }
                                                        ]
                                                    }
                                                },
                                                {
                                                    id: 'e6',
                                                    move: '3... e6',
                                                    player: 'black',
                                                    label: 'Solid',
                                                    response: {
                                                        id: 'Bd3',
                                                        move: '4. Bd3',
                                                        player: 'white',
                                                        explanation: 'Target h7.',
                                                        children: []
                                                    }
                                                }
                                            ]
                                        }
                                    }
                                ]
                            }
                        },
                        {
                            id: 'Nf6',
                            move: '1... Nf6',
                            player: 'black',
                            label: 'Indian',
                            response: {
                                id: 'Bf4_2',
                                move: '2. Bf4',
                                player: 'white',
                                explanation: 'London works vs anything!',
                                children: []
                            }
                        }
                    ]
                }
            },

            sicilian_najdorf: {
                name: "Sicilian Najdorf",
                color: "black",
                description: "Fighting response to 1.e4",
                startingMoves: "1. e4 c5 2. Nf3 d6 3. d4 cxd4 4. Nxd4 Nf6 5. Nc3 a6",
                tree: {
                    id: 'start',
                    move: '1. e4',
                    player: 'white',
                    explanation: 'White plays e4.',
                    children: [
                        {
                            id: 'c5',
                            move: '1... c5',
                            player: 'black',
                            label: 'Sicilian!',
                            response: {
                                id: 'Nf3',
                                move: '2. Nf3',
                                player: 'white',
                                explanation: 'Open Sicilian.',
                                children: [
                                    {
                                        id: 'd6',
                                        move: '2... d6',
                                        player: 'black',
                                        label: 'Main',
                                        response: {
                                            id: 'd4',
                                            move: '3. d4',
                                            player: 'white',
                                            explanation: 'Opening center.',
                                            children: [
                                                {
                                                    id: 'cxd4',
                                                    move: '3... cxd4',
                                                    player: 'black',
                                                    label: 'Take',
                                                    response: {
                                                        id: 'Nxd4',
                                                        move: '4. Nxd4',
                                                        player: 'white',
                                                        explanation: 'Open Sicilian.',
                                                        children: [
                                                            {
                                                                id: 'Nf6',
                                                                move: '4... Nf6',
                                                                player: 'black',
                                                                label: 'Attack e4',
                                                                response: {
                                                                    id: 'Nc3',
                                                                    move: '5. Nc3',
                                                                    player: 'white',
                                                                    explanation: 'Defend.',
                                                                    children: [
                                                                        {
                                                                            id: 'a6',
                                                                            move: '5... a6',
                                                                            player: 'black',
                                                                            label: 'Najdorf!',
                                                                            response: {
                                                                                id: 'choice_w',
                                                                                move: 'White chooses',
                                                                                player: 'white',
                                                                                explanation: 'Critical crossroads.',
                                                                                isChoice: true,
                                                                                choices: [
                                                                                    {
                                                                                        id: 'Be3',
                                                                                        move: '6. Be3',
                                                                                        name: 'English Attack',
                                                                                        style: 'f3, Qd2, O-O-O',
                                                                                        color: 'red',
                                                                                        explanation: 'Aggressive setup.',
                                                                                        children: [
                                                                                            {
                                                                                                id: 'e5',
                                                                                                move: '6... e5',
                                                                                                player: 'black',
                                                                                                label: 'Kick',
                                                                                                response: {
                                                                                                    id: 'Nb3',
                                                                                                    move: '7. Nb3',
                                                                                                    player: 'white',
                                                                                                    explanation: 'Retreat.',
                                                                                                    children: []
                                                                                                }
                                                                                            }
                                                                                        ]
                                                                                    },
                                                                                    {
                                                                                        id: 'Bg5',
                                                                                        move: '6. Bg5',
                                                                                        name: 'Classical',
                                                                                        style: 'Traditional',
                                                                                        color: 'blue',
                                                                                        explanation: 'Pin knight.',
                                                                                        children: []
                                                                                    },
                                                                                    {
                                                                                        id: 'f3',
                                                                                        move: '6. f3',
                                                                                        name: 'English Attack',
                                                                                        style: 'Direct',
                                                                                        color: 'purple',
                                                                                        explanation: 'Prepare Be3.',
                                                                                        children: []
                                                                                    }
                                                                                ]
                                                                            }
                                                                        }
                                                                    ]
                                                                }
                                                            }
                                                        ]
                                                    }
                                                }
                                            ]
                                        }
                                    }
                                ]
                            }
                        }
                    ]
                }
            },

            caro_kann: {
                name: "Caro-Kann Defense",
                color: "black",
                description: "Solid defense to 1.e4",
                startingMoves: "1. e4 c6 2. d4 d5",
                tree: {
                    id: 'start',
                    move: '1. e4',
                    player: 'white',
                    explanation: 'White plays e4.',
                    children: [
                        {
                            id: 'c6',
                            move: '1... c6',
                            player: 'black',
                            label: 'Caro-Kann!',
                            response: {
                                id: 'd4',
                                move: '2. d4',
                                player: 'white',
                                explanation: 'Building center.',
                                children: [
                                    {
                                        id: 'd5',
                                        move: '2... d5',
                                        player: 'black',
                                        label: 'Challenge',
                                        response: {
                                            id: 'choice_ck',
                                            move: 'White chooses',
                                            player: 'white',
                                            explanation: 'Main options:',
                                            isChoice: true,
                                            choices: [
                                                {
                                                    id: 'Nc3',
                                                    move: '3. Nc3',
                                                    name: 'Classical',
                                                    style: 'Main Line',
                                                    color: 'blue',
                                                    explanation: 'Defend e4.',
                                                    children: [
                                                        {
                                                            id: 'dxe4',
                                                            move: '3... dxe4',
                                                            player: 'black',
                                                            label: 'Take',
                                                            response: {
                                                                id: 'Nxe4',
                                                                move: '4. Nxe4',
                                                                player: 'white',
                                                                explanation: 'Recapture.',
                                                                children: [
                                                                    {
                                                                        id: 'Bf5',
                                                                        move: '4... Bf5',
                                                                        player: 'black',
                                                                        label: 'Classical',
                                                                        response: {
                                                                            id: 'Ng3',
                                                                            move: '5. Ng3',
                                                                            player: 'white',
                                                                            explanation: 'Attack bishop.',
                                                                            children: [
                                                                                {
                                                                                    id: 'Bg6',
                                                                                    move: '5... Bg6',
                                                                                    player: 'black',
                                                                                    label: 'Retreat',
                                                                                    response: {
                                                                                        id: 'h4',
                                                                                        move: '6. h4',
                                                                                        player: 'white',
                                                                                        explanation: 'Typical attack.',
                                                                                        children: []
                                                                                    }
                                                                                }
                                                                            ]
                                                                        }
                                                                    }
                                                                ]
                                                            }
                                                        }
                                                    ]
                                                },
                                                {
                                                    id: 'e5',
                                                    move: '3. e5',
                                                    name: 'Advance',
                                                    style: 'Space',
                                                    color: 'red',
                                                    explanation: 'Grab space.',
                                                    children: [
                                                        {
                                                            id: 'Bf5',
                                                            move: '3... Bf5',
                                                            player: 'black',
                                                            label: 'Develop',
                                                            response: {
                                                                id: 'Nf3_adv',
                                                                move: '4. Nf3',
                                                                player: 'white',
                                                                explanation: 'Normal.',
                                                                children: []
                                                            }
                                                        }
                                                    ]
                                                },
                                                {
                                                    id: 'exd5',
                                                    move: '3. exd5',
                                                    name: 'Exchange',
                                                    style: 'Simplified',
                                                    color: 'green',
                                                    explanation: 'Trade off.',
                                                    children: []
                                                }
                                            ]
                                        }
                                    }
                                ]
                            }
                        }
                    ]
                }
            }
        };

        let OPENINGS = {};
        let editMode = false;

        // ============================================================
        // APP STATE
        // ============================================================
        
        let currentOpening = null;
        let currentOpeningKey = null;
        let currentPath = [];
        let userColor = 'white';

        // Builder state
        let builderColor = 'white';
        let builderMoves = [];
        let editingKey = null;

        // ============================================================
        // INITIALIZATION
        // ============================================================

        function init() {
            loadOpenings();
            renderOpenings();
        }

        function loadOpenings() {
            // Start with defaults
            OPENINGS = JSON.parse(JSON.stringify(DEFAULT_OPENINGS));
            
            // Load saved
            try {
                const saved = localStorage.getItem('chessOpeningsV2');
                if (saved) {
                    OPENINGS = JSON.parse(saved);
                }
            } catch (e) {
                console.error('Error loading:', e);
            }
        }

        function saveAllOpenings() {
            localStorage.setItem('chessOpeningsV2', JSON.stringify(OPENINGS));
        }

        function resetToDefaults() {
            localStorage.removeItem('chessOpeningsV2');
            OPENINGS = JSON.parse(JSON.stringify(DEFAULT_OPENINGS));
            hideResetBar();
            renderOpenings();
        }

        function showResetBar() {
            document.getElementById('resetBar').style.display = 'flex';
        }

        function hideResetBar() {
            document.getElementById('resetBar').style.display = 'none';
        }

        // ============================================================
        // MENU SCREEN
        // ============================================================

        function toggleEditMode() {
            editMode = !editMode;
            renderOpenings();
        }

        function renderOpenings() {
            const container = document.getElementById('openingsContainer');
            
            const whiteOpenings = Object.entries(OPENINGS).filter(([_, o]) => o.color === 'white');
            const blackOpenings = Object.entries(OPENINGS).filter(([_, o]) => o.color === 'black');

            let html = '';

            // White openings
            html += `<p class="section-title">
                Playing as White
                <button class="edit-mode-toggle ${editMode ? 'active' : ''}" onclick="toggleEditMode()">
                    ${editMode ? '‚úì Done' : '‚úèÔ∏è Edit'}
                </button>
            </p>`;
            
            whiteOpenings.forEach(([key, opening]) => {
                html += renderOpeningCard(key, opening);
            });

            // Black openings
            if (blackOpenings.length > 0) {
                html += '<p class="section-title">Playing as Black</p>';
                blackOpenings.forEach(([key, opening]) => {
                    html += renderOpeningCard(key, opening);
                });
            }

            if (editMode) {
                html += `<p style="text-align: center; margin-top: 16px;">
                    <button onclick="showResetBar()" style="background: none; border: none; color: #ef4444; cursor: pointer; font-size: 0.8rem;">
                        Reset All to Defaults
                    </button>
                </p>`;
            }

            container.innerHTML = html;
        }

        function renderOpeningCard(key, opening) {
            return `
                <div class="opening-card" onclick="${editMode ? '' : `startTraining('${key}')`}">
                    <h3>${opening.name}<span class="color-badge ${opening.color}">${opening.color.charAt(0).toUpperCase() + opening.color.slice(1)}</span></h3>
                    <p>${opening.description}</p>
                    <div class="moves">${opening.startingMoves}</div>
                    <div class="card-actions ${editMode ? 'visible' : ''}">
                        <button class="card-action-btn" onclick="event.stopPropagation(); exportOpening('${key}')" title="Export">üì§</button>
                        <button class="card-action-btn delete" onclick="event.stopPropagation(); deleteOpening('${key}')" title="Delete">üóëÔ∏è</button>
                    </div>
                </div>
            `;
        }

        function deleteOpening(key) {
            const name = OPENINGS[key]?.name || key;
            if (confirm(`Delete "${name}"?`)) {
                delete OPENINGS[key];
                saveAllOpenings();
                renderOpenings();
            }
        }

        function exportOpening(key) {
            const json = JSON.stringify(OPENINGS[key], null, 2);
            navigator.clipboard.writeText(json).then(() => {
                alert(`"${OPENINGS[key].name}" copied to clipboard!`);
            });
        }

        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(screenId).classList.add('active');
        }

        function goToMenu() {
            showScreen('menuScreen');
            currentOpening = null;
            currentPath = [];
            editMode = false;
            renderOpenings();
        }

        // ============================================================
        // TRAINER SCREEN
        // ============================================================

        function startTraining(openingKey) {
            currentOpening = OPENINGS[openingKey];
            currentOpeningKey = openingKey;
            userColor = currentOpening.color;
            currentPath = [];

            showScreen('trainerScreen');
            document.getElementById('openingTitle').textContent = currentOpening.name;
            document.getElementById('openingSubtitle').textContent = `Playing as ${userColor.charAt(0).toUpperCase() + userColor.slice(1)}`;

            renderTrainer();
        }

        function getCurrentNode() {
            let node = currentOpening.tree;
            for (const pathId of currentPath) {
                if (node.children) {
                    const child = node.children.find(c => c.id === pathId);
                    if (child) node = child.response || child;
                } else if (node.choices) {
                    const choice = node.choices.find(c => c.id === pathId);
                    if (choice) node = choice;
                } else if (node.response?.children) {
                    const child = node.response.children.find(c => c.id === pathId);
                    if (child) node = child.response || child;
                }
            }
            return node;
        }

        function getOptions(node) {
            if (node.isChoice && node.choices) return { type: 'choices', options: node.choices };
            if (node.children?.length > 0) return { type: 'moves', options: node.children };
            if (node.response?.children?.length > 0) return { type: 'moves', options: node.response.children };
            return { type: 'end', options: [] };
        }

        function getMoveHistory() {
            let history = [{ move: currentOpening.tree.move, player: currentOpening.tree.player }];
            let node = currentOpening.tree;

            for (const pathId of currentPath) {
                if (node.children) {
                    const child = node.children.find(c => c.id === pathId);
                    if (child) {
                        history.push({ move: child.move, player: child.player });
                        if (child.response) {
                            history.push({ move: child.response.move, player: child.response.player, isChoice: child.response.isChoice });
                            node = child.response;
                        }
                    }
                } else if (node.choices) {
                    const choice = node.choices.find(c => c.id === pathId);
                    if (choice) {
                        history.push({ move: choice.move, player: userColor, isChoice: true });
                        node = choice;
                    }
                } else if (node.response?.children) {
                    const child = node.response.children.find(c => c.id === pathId);
                    if (child) {
                        history.push({ move: child.move, player: child.player });
                        if (child.response) {
                            history.push({ move: child.response.move, player: child.response.player });
                            node = child.response;
                        }
                    }
                }
            }
            return history;
        }

        function renderTrainer() {
            const node = getCurrentNode();
            const options = getOptions(node);
            const history = getMoveHistory();
            const moveCount = Math.ceil(history.length / 2);

            // Move history
            document.getElementById('moveHistory').innerHTML = history.map(m => {
                const colorClass = m.player === 'white' ? 'white-move' : 'black-move';
                return `<span class="move-tag ${colorClass} ${m.isChoice ? 'choice' : ''}">${m.move}</span>`;
            }).join('');

            // Current move
            const isUserMove = node.player === userColor;

            let cardHtml = `
                <div class="move-label">
                    <div class="move-dot ${isUserMove ? 'your-move' : 'opponent-move'}"></div>
                    <span class="${isUserMove ? 'your-move' : 'opponent-move'}">${isUserMove ? 'Your Move' : 'Opponent\'s Move'}</span>
                </div>
                <div class="current-move ${isUserMove ? '' : 'opponent'}">
                    <h2>${node.move}</h2>
                </div>
                <p class="explanation">${node.explanation || ''}</p>
            `;

            // Options
            if (options.type === 'moves' && options.options.length > 0) {
                cardHtml += `<div class="options-section">
                    <div class="options-label">
                        <div class="move-dot opponent-move"></div>
                        <span>${userColor === 'white' ? 'Black' : 'White'} might play...</span>
                    </div>`;
                options.options.forEach(opt => {
                    const labelClass = opt.label?.includes('BLUNDER') ? 'blunder' : 
                                      (opt.label === 'Main' || opt.label === 'Main Line') ? 'main' : '';
                    cardHtml += `<button class="option-btn" onclick="selectOption('${opt.id}')">
                        <span class="move-text">${opt.move}</span>
                        ${opt.label ? `<span class="label ${labelClass}">${opt.label}</span>` : ''}
                        <span class="arrow">‚Üí</span>
                    </button>`;
                });
                cardHtml += '</div>';
            } else if (options.type === 'choices') {
                cardHtml += `<div class="options-section">
                    <div class="options-label">
                        <div class="move-dot your-move"></div>
                        <span>Choose your approach:</span>
                    </div>
                    <div class="choices-grid">`;
                options.options.forEach(c => {
                    cardHtml += `<button class="choice-card ${c.color || 'blue'}" onclick="selectOption('${c.id}')">
                        <h4>${c.move}</h4>
                        <p class="name">${c.name || ''}</p>
                        <p class="style">${c.style || ''}</p>
                    </button>`;
                });
                cardHtml += '</div></div>';
            } else {
                cardHtml += `<div class="end-card">
                    <div class="icon">üéØ</div>
                    <h3>End of Line</h3>
                    <p>Move ${moveCount} reached!</p>
                </div>`;
            }

            document.getElementById('currentMoveCard').innerHTML = cardHtml;
            document.getElementById('controls').innerHTML = currentPath.length > 0 ? `
                <button class="control-btn secondary" onclick="goBack()">‚Üê Back</button>
                <button class="control-btn secondary" onclick="reset()">Start Over</button>
            ` : '';
            document.getElementById('progressDots').innerHTML = Array.from({length: 12}, (_, i) => 
                `<div class="progress-dot ${i < moveCount ? 'active' : ''}"></div>`).join('');
        }

        function selectOption(id) { currentPath.push(id); renderTrainer(); }
        function goBack() { currentPath.pop(); renderTrainer(); }
        function reset() { currentPath = []; renderTrainer(); }

        // ============================================================
        // BUILDER
        // ============================================================

        function showBuilder() {
            showScreen('builderScreen');
            resetBuilder();
            document.getElementById('builderSubtitle').textContent = 'Create your own opening';
        }

        function resetBuilder() {
            builderColor = 'white';
            builderMoves = [];
            editingKey = null;
            document.getElementById('openingName').value = '';
            document.getElementById('openingDesc').value = '';
            updateColorToggle();
            renderBuilderMoves();
        }

        function switchTab(tab) {
            document.getElementById('tabVisual').classList.toggle('active', tab === 'visual');
            document.getElementById('tabJson').classList.toggle('active', tab === 'json');
            document.getElementById('visualBuilder').style.display = tab === 'visual' ? 'block' : 'none';
            document.getElementById('jsonBuilder').style.display = tab === 'json' ? 'block' : 'none';
            if (tab === 'json') updateJsonPreview();
        }

        function setBuilderColor(color) {
            builderColor = color;
            updateColorToggle();
        }

        function updateColorToggle() {
            document.querySelectorAll('.color-option').forEach(el => {
                el.classList.toggle('selected', el.classList.contains(builderColor));
            });
        }

        function addBuilderMove() {
            const move = document.getElementById('newMove').value.trim();
            if (!move) return;

            const moveNum = Math.floor(builderMoves.length / 2) + 1;
            const isWhite = builderMoves.length % 2 === 0;
            
            builderMoves.push({
                id: `m${Date.now()}`,
                move: isWhite ? `${moveNum}. ${move}` : `${moveNum}... ${move}`,
                player: isWhite ? 'white' : 'black',
                explanation: document.getElementById('newExplanation').value.trim()
            });

            document.getElementById('newMove').value = '';
            document.getElementById('newExplanation').value = '';
            renderBuilderMoves();
        }

        function deleteBuilderMove(index) {
            builderMoves.splice(index);
            renderBuilderMoves();
        }

        function renderBuilderMoves() {
            const container = document.getElementById('moveList');
            if (builderMoves.length === 0) {
                container.innerHTML = '<p style="color: #64748b; text-align: center; padding: 16px;">Add moves below</p>';
                return;
            }
            container.innerHTML = builderMoves.map((m, i) => `
                <div class="move-item">
                    <span class="move-number">${i + 1}</span>
                    <span class="move-notation ${m.player}">${m.move}</span>
                    <button class="delete-move" onclick="deleteBuilderMove(${i})">√ó</button>
                </div>
            `).join('');
        }

        function buildTree() {
            if (builderMoves.length === 0) return null;

            const tree = {
                id: 'start',
                move: builderMoves[0].move,
                player: builderMoves[0].player,
                explanation: builderMoves[0].explanation || '',
                children: []
            };

            let current = tree;
            for (let i = 1; i < builderMoves.length; i++) {
                const m = builderMoves[i];
                const child = {
                    id: m.id,
                    move: m.move,
                    player: m.player,
                    label: '',
                    response: null
                };
                
                current.children = [child];
                
                if (i + 1 < builderMoves.length) {
                    child.response = {
                        id: `r${m.id}`,
                        move: builderMoves[i + 1].move,
                        player: builderMoves[i + 1].player,
                        explanation: builderMoves[i + 1].explanation || '',
                        children: []
                    };
                    current = child.response;
                    i++;
                }
            }
            return tree;
        }

        function buildOpeningObject() {
            return {
                name: document.getElementById('openingName').value.trim() || 'My Opening',
                color: builderColor,
                description: document.getElementById('openingDesc').value.trim() || 'Custom opening',
                startingMoves: builderMoves.slice(0, 4).map(m => m.move).join(' ') || '...',
                tree: buildTree() || { id: 'start', move: '...', player: 'white', explanation: '', children: [] }
            };
        }

        function previewOpening() {
            const o = buildOpeningObject();
            OPENINGS['_preview'] = o;
            startTraining('_preview');
        }

        function saveOpening() {
            const name = document.getElementById('openingName').value.trim();
            if (!name) return alert('Enter a name');
            if (builderMoves.length === 0) return alert('Add some moves');

            const key = name.toLowerCase().replace(/[^a-z0-9]/g, '_') + '_' + Date.now();
            OPENINGS[key] = buildOpeningObject();
            saveAllOpenings();
            alert(`"${name}" saved!`);
            goToMenu();
        }

        function updateJsonPreview() {
            document.getElementById('jsonPreview').textContent = JSON.stringify(buildOpeningObject(), null, 2);
        }

        function copyJson() {
            navigator.clipboard.writeText(document.getElementById('jsonPreview').textContent)
                .then(() => alert('Copied!'));
        }

        function importJson() {
            try {
                const o = JSON.parse(document.getElementById('jsonInput').value);
                if (!o.name || !o.tree) return alert('Invalid format');
                const key = o.name.toLowerCase().replace(/[^a-z0-9]/g, '_') + '_' + Date.now();
                OPENINGS[key] = o;
                saveAllOpenings();
                alert(`"${o.name}" imported!`);
                goToMenu();
            } catch (e) { alert('Invalid JSON: ' + e.message); }
        }

        document.addEventListener('DOMContentLoaded', () => {
            init();
            document.getElementById('newMove').addEventListener('keypress', e => { if (e.key === 'Enter') addBuilderMove(); });
        });
    </script>
</body>
</html>
