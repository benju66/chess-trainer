<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Chess Opening Trainer</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 50%, #1e293b 100%);
            min-height: 100vh;
            color: #e2e8f0;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
            padding: 16px;
            padding-bottom: 100px;
        }

        .header {
            text-align: center;
            padding: 20px 0;
        }

        .header h1 {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .header p {
            color: #94a3b8;
            font-size: 0.875rem;
        }

        .section-title {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: #64748b;
            margin-top: 16px;
            margin-bottom: 8px;
        }

        .opening-card {
            background: rgba(51, 65, 85, 0.5);
            border: 1px solid #334155;
            border-radius: 12px;
            padding: 16px;
            padding-right: 50px;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
            margin-bottom: 12px;
        }

        .opening-card:hover {
            background: rgba(71, 85, 105, 0.5);
            border-color: #475569;
        }

        .opening-card h3 {
            font-size: 1.125rem;
            margin-bottom: 4px;
        }

        .opening-card p {
            color: #94a3b8;
            font-size: 0.875rem;
        }

        .opening-card .moves {
            font-family: monospace;
            color: #fbbf24;
            font-size: 0.8rem;
            margin-top: 8px;
        }

        .color-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: 600;
            margin-left: 8px;
        }

        .color-badge.white {
            background: #fbbf24;
            color: #1e293b;
        }

        .color-badge.black {
            background: #475569;
            color: #e2e8f0;
        }

        .delete-btn {
            position: absolute;
            top: 50%;
            right: 12px;
            transform: translateY(-50%);
            background: rgba(100, 116, 139, 0.3);
            border: none;
            color: #94a3b8;
            width: 32px;
            height: 32px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1rem;
        }

        .delete-btn:hover {
            background: rgba(239, 68, 68, 0.3);
            color: #f87171;
        }

        .screen { display: none; }
        .screen.active { display: block; }

        .back-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            background: none;
            border: none;
            color: #94a3b8;
            font-size: 0.875rem;
            cursor: pointer;
            padding: 8px 0;
            margin-bottom: 16px;
        }

        .back-btn:hover { color: #e2e8f0; }

        .move-history {
            background: rgba(30, 41, 59, 0.5);
            border: 1px solid #334155;
            border-radius: 12px;
            padding: 12px;
            margin-bottom: 16px;
            overflow-x: auto;
        }

        .move-history-inner {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
        }

        .move-tag {
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 0.8rem;
            font-family: monospace;
            white-space: nowrap;
        }

        .move-tag.white-move {
            background: rgba(251, 191, 36, 0.2);
            color: #fbbf24;
        }

        .move-tag.black-move {
            background: rgba(71, 85, 105, 0.5);
            color: #cbd5e1;
        }

        .move-tag.choice {
            border: 1px solid #fbbf24;
        }

        .current-move-card {
            background: #334155;
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 16px;
        }

        .move-label {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 12px;
        }

        .move-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }

        .move-dot.your-move {
            background: #fbbf24;
            box-shadow: 0 0 12px rgba(251, 191, 36, 0.4);
        }

        .move-dot.opponent-move {
            background: #64748b;
        }

        .move-label span {
            font-weight: 600;
            font-size: 0.875rem;
        }

        .move-label span.your-move { color: #fbbf24; }
        .move-label span.opponent-move { color: #94a3b8; }

        .current-move {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
        }

        .current-move.opponent {
            background: linear-gradient(135deg, #475569 0%, #334155 100%);
        }

        .current-move h2 {
            font-family: monospace;
            font-size: 1.5rem;
            color: #1e293b;
        }

        .current-move.opponent h2 { color: #e2e8f0; }

        .explanation {
            color: #cbd5e1;
            font-size: 1rem;
            line-height: 1.5;
        }

        .options-section { margin-top: 20px; }

        .options-label {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 12px;
            color: #94a3b8;
            font-size: 0.875rem;
            font-weight: 600;
        }

        .option-btn {
            width: 100%;
            background: rgba(51, 65, 85, 0.5);
            border: 1px solid #475569;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: left;
            color: #e2e8f0;
        }

        .option-btn:hover {
            background: rgba(71, 85, 105, 0.6);
            border-color: #64748b;
        }

        .option-btn .move-text {
            font-family: monospace;
            font-size: 1.25rem;
            font-weight: 600;
        }

        .option-btn .label {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.7rem;
            margin-left: 8px;
            background: #475569;
        }

        .option-btn .label.main {
            background: rgba(16, 185, 129, 0.2);
            color: #34d399;
        }

        .option-btn .label.blunder {
            background: rgba(239, 68, 68, 0.2);
            color: #f87171;
        }

        .option-btn .arrow {
            float: right;
            color: #64748b;
            font-size: 1.5rem;
        }

        .choices-grid {
            display: grid;
            gap: 12px;
        }

        @media (min-width: 500px) {
            .choices-grid { grid-template-columns: repeat(3, 1fr); }
        }

        .choice-card {
            background: rgba(51, 65, 85, 0.3);
            border: 2px solid;
            border-radius: 12px;
            padding: 16px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: left;
        }

        .choice-card:hover { transform: scale(1.02); }

        .choice-card.red { border-color: rgba(239, 68, 68, 0.5); }
        .choice-card.red:hover { border-color: #ef4444; background: rgba(239, 68, 68, 0.1); }
        .choice-card.blue { border-color: rgba(59, 130, 246, 0.5); }
        .choice-card.blue:hover { border-color: #3b82f6; background: rgba(59, 130, 246, 0.1); }
        .choice-card.purple { border-color: rgba(168, 85, 247, 0.5); }
        .choice-card.purple:hover { border-color: #a855f7; background: rgba(168, 85, 247, 0.1); }
        .choice-card.green { border-color: rgba(34, 197, 94, 0.5); }
        .choice-card.green:hover { border-color: #22c55e; background: rgba(34, 197, 94, 0.1); }

        .choice-card h4 { font-family: monospace; font-size: 1rem; margin-bottom: 4px; }
        .choice-card.red h4 { color: #f87171; }
        .choice-card.blue h4 { color: #60a5fa; }
        .choice-card.purple h4 { color: #c084fc; }
        .choice-card.green h4 { color: #4ade80; }

        .choice-card .name { font-weight: 600; font-size: 0.8rem; margin-bottom: 2px; }
        .choice-card.red .name { color: #fca5a5; }
        .choice-card.blue .name { color: #93c5fd; }
        .choice-card.purple .name { color: #d8b4fe; }
        .choice-card.green .name { color: #86efac; }

        .choice-card .style { font-size: 0.7rem; color: #94a3b8; }

        .end-card {
            text-align: center;
            padding: 32px 16px;
        }

        .end-card .icon { font-size: 3rem; margin-bottom: 16px; }
        .end-card h3 { font-size: 1.25rem; margin-bottom: 8px; }
        .end-card p { color: #94a3b8; }

        .controls {
            display: flex;
            gap: 12px;
            margin-top: 20px;
        }

        .control-btn {
            flex: 1;
            padding: 14px;
            border: none;
            border-radius: 10px;
            font-size: 0.875rem;
            font-weight: 600;
            cursor: pointer;
        }

        .control-btn.secondary {
            background: #475569;
            color: #e2e8f0;
        }

        .control-btn.secondary:hover { background: #64748b; }

        .progress-dots {
            display: flex;
            justify-content: center;
            gap: 4px;
            margin-top: 20px;
        }

        .progress-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #334155;
        }

        .progress-dot.active { background: #fbbf24; }

        .tip-box {
            background: rgba(30, 41, 59, 0.5);
            border: 1px solid #334155;
            border-radius: 10px;
            padding: 12px;
            margin-top: 20px;
            font-size: 0.8rem;
            color: #94a3b8;
            text-align: center;
        }

        .btn-row {
            display: flex;
            gap: 12px;
            margin-top: 16px;
        }

        .btn {
            flex: 1;
            padding: 16px;
            border-radius: 12px;
            font-size: 0.875rem;
            font-weight: 600;
            cursor: pointer;
            text-align: center;
            border: none;
        }

        .btn-primary {
            background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
            color: white;
        }

        .btn-primary:hover { transform: scale(1.02); }

        .btn-secondary {
            background: rgba(71, 85, 105, 0.5);
            border: 1px solid #475569;
            color: #e2e8f0;
        }

        /* Builder Styles */
        .builder-section {
            background: rgba(30, 41, 59, 0.5);
            border: 1px solid #334155;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
        }

        .builder-section h3 {
            font-size: 0.875rem;
            color: #94a3b8;
            margin-bottom: 12px;
        }

        .form-group { margin-bottom: 16px; }

        .form-group label {
            display: block;
            font-size: 0.8rem;
            color: #94a3b8;
            margin-bottom: 6px;
        }

        .form-group input, .form-group textarea {
            width: 100%;
            padding: 12px;
            background: #1e293b;
            border: 1px solid #334155;
            border-radius: 8px;
            color: #e2e8f0;
            font-size: 1rem;
        }

        .form-group input:focus, .form-group textarea:focus {
            outline: none;
            border-color: #fbbf24;
        }

        .color-toggle { display: flex; gap: 12px; }

        .color-option {
            flex: 1;
            padding: 12px;
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            font-weight: 600;
        }

        .color-option.white {
            background: rgba(251, 191, 36, 0.1);
            border: 2px solid rgba(251, 191, 36, 0.3);
            color: #fbbf24;
        }

        .color-option.white.selected {
            background: rgba(251, 191, 36, 0.2);
            border-color: #fbbf24;
        }

        .color-option.black {
            background: rgba(100, 116, 139, 0.1);
            border: 2px solid rgba(100, 116, 139, 0.3);
            color: #94a3b8;
        }

        .color-option.black.selected {
            background: rgba(100, 116, 139, 0.2);
            border-color: #94a3b8;
        }

        /* Breadcrumb / Path Display */
        .path-display {
            background: #1e293b;
            border-radius: 8px;
            padding: 10px 12px;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 6px;
            flex-wrap: wrap;
            font-size: 0.8rem;
        }

        .path-crumb {
            color: #64748b;
        }

        .path-crumb.current {
            color: #fbbf24;
            font-weight: 600;
        }

        .path-sep {
            color: #475569;
        }

        /* Move Tree Display */
        .move-tree {
            background: #1e293b;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 12px;
            min-height: 100px;
            max-height: 300px;
            overflow-y: auto;
        }

        .tree-node {
            margin-bottom: 4px;
        }

        .tree-move {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 10px;
            background: rgba(51, 65, 85, 0.5);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.15s;
        }

        .tree-move:hover {
            background: rgba(71, 85, 105, 0.6);
        }

        .tree-move.selected {
            background: rgba(251, 191, 36, 0.2);
            border: 1px solid rgba(251, 191, 36, 0.4);
        }

        .tree-move .notation {
            font-family: monospace;
            font-weight: 600;
            min-width: 70px;
        }

        .tree-move .notation.white { color: #fbbf24; }
        .tree-move .notation.black { color: #cbd5e1; }

        .tree-move .expl {
            font-size: 0.75rem;
            color: #64748b;
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .tree-move .branch-count {
            background: rgba(168, 85, 247, 0.2);
            color: #c084fc;
            font-size: 0.65rem;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: 600;
        }

        .tree-move .del {
            background: none;
            border: none;
            color: #64748b;
            cursor: pointer;
            padding: 2px 6px;
            font-size: 1rem;
            opacity: 0.5;
        }

        .tree-move .del:hover {
            color: #f87171;
            opacity: 1;
        }

        .tree-children {
            margin-left: 20px;
            border-left: 2px solid #334155;
            padding-left: 10px;
            margin-top: 4px;
        }

        .tree-branches {
            margin-left: 20px;
            margin-top: 4px;
        }

        .branch-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 10px;
            background: rgba(71, 85, 105, 0.3);
            border-radius: 6px;
            margin-bottom: 4px;
            cursor: pointer;
            border-left: 3px solid #64748b;
        }

        .branch-item:hover {
            background: rgba(71, 85, 105, 0.5);
        }

        .branch-item.active {
            border-left-color: #a855f7;
            background: rgba(168, 85, 247, 0.1);
        }

        .branch-item .notation {
            font-family: monospace;
            font-weight: 600;
            color: #cbd5e1;
        }

        .branch-item .label-text {
            font-size: 0.7rem;
            color: #94a3b8;
        }

        /* Add Move Section */
        .add-section {
            background: rgba(34, 197, 94, 0.05);
            border: 1px dashed rgba(34, 197, 94, 0.3);
            border-radius: 8px;
            padding: 12px;
            margin-top: 12px;
        }

        .add-section-title {
            font-size: 0.75rem;
            color: #4ade80;
            margin-bottom: 10px;
            font-weight: 600;
        }

        .add-row {
            display: flex;
            gap: 8px;
            margin-bottom: 8px;
        }

        .add-row input {
            flex: 1;
            padding: 10px;
            background: #1e293b;
            border: 1px solid #334155;
            border-radius: 6px;
            color: #e2e8f0;
            font-family: monospace;
        }

        .add-row input.label-input {
            flex: 0.7;
            font-family: inherit;
        }

        .add-row input.expl-input {
            flex: 1.5;
            font-family: inherit;
        }

        .add-row button {
            padding: 10px 16px;
            background: #22c55e;
            border: none;
            border-radius: 6px;
            color: white;
            font-weight: 600;
            cursor: pointer;
            white-space: nowrap;
        }

        .add-row button:hover {
            background: #16a34a;
        }

        .add-row button.branch-btn {
            background: #8b5cf6;
        }

        .add-row button.branch-btn:hover {
            background: #7c3aed;
        }

        .help { font-size: 0.75rem; color: #64748b; margin-top: 8px; }

        .current-position {
            background: rgba(251, 191, 36, 0.1);
            border: 1px solid rgba(251, 191, 36, 0.3);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 12px;
        }

        .current-position-label {
            font-size: 0.7rem;
            color: #fbbf24;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 6px;
        }

        .current-position-move {
            font-family: monospace;
            font-size: 1.1rem;
            font-weight: 600;
            color: #e2e8f0;
        }

        .current-position-expl {
            font-size: 0.8rem;
            color: #94a3b8;
            margin-top: 4px;
        }

        .opponent-responses {
            margin-top: 12px;
        }

        .opponent-responses-title {
            font-size: 0.75rem;
            color: #94a3b8;
            margin-bottom: 8px;
        }

        .response-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 12px;
            background: rgba(51, 65, 85, 0.5);
            border-radius: 8px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.15s;
        }

        .response-item:hover {
            background: rgba(71, 85, 105, 0.6);
        }

        .response-item .notation {
            font-family: monospace;
            font-weight: 600;
            color: #cbd5e1;
            min-width: 80px;
        }

        .response-item .label-tag {
            background: #475569;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.7rem;
            color: #cbd5e1;
        }

        .response-item .arrow {
            margin-left: auto;
            color: #64748b;
        }

        .response-item .del {
            background: none;
            border: none;
            color: #64748b;
            cursor: pointer;
            padding: 4px 8px;
        }

        .response-item .del:hover {
            color: #f87171;
        }

        .empty-state {
            text-align: center;
            padding: 30px 20px;
            color: #64748b;
        }

        .empty-state .icon {
            font-size: 2rem;
            margin-bottom: 10px;
        }

        .tabs { display: flex; gap: 8px; margin-bottom: 16px; }

        .tab {
            flex: 1;
            padding: 12px;
            background: rgba(51, 65, 85, 0.3);
            border: 1px solid #334155;
            border-radius: 8px;
            color: #94a3b8;
            font-weight: 600;
            cursor: pointer;
            text-align: center;
        }

        .tab.active {
            background: rgba(251, 191, 36, 0.1);
            border-color: #fbbf24;
            color: #fbbf24;
        }

        .json-area {
            width: 100%;
            min-height: 150px;
            background: #0f172a;
            border: 1px solid #334155;
            border-radius: 8px;
            padding: 12px;
            color: #e2e8f0;
            font-family: monospace;
            font-size: 0.75rem;
            resize: vertical;
        }

        .copy-btn {
            margin-top: 8px;
            padding: 8px 16px;
            background: #475569;
            border: none;
            border-radius: 6px;
            color: white;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Menu Screen -->
        <div class="screen active" id="menuScreen">
            <div class="header">
                <h1>‚ôüÔ∏è Opening Trainer</h1>
                <p>Master your chess openings move by move</p>
            </div>
            <div id="openingsContainer"></div>
            <div class="btn-row">
                <button class="btn btn-primary" onclick="showBuilder()">+ Create New Opening</button>
            </div>
        </div>

        <!-- Trainer Screen -->
        <div class="screen" id="trainerScreen">
            <button class="back-btn" onclick="goToMenu()">‚Üê Back</button>
            <div class="header">
                <h1 id="openingTitle"></h1>
                <p id="openingSubtitle"></p>
            </div>
            <div class="move-history"><div class="move-history-inner" id="moveHistory"></div></div>
            <div class="current-move-card" id="currentMoveCard"></div>
            <div class="controls" id="controls"></div>
            <div class="progress-dots" id="progressDots"></div>
            <div class="tip-box">üí° <span id="tipText">Click moves to explore</span></div>
        </div>

        <!-- Builder Screen -->
        <div class="screen" id="builderScreen">
            <button class="back-btn" onclick="goToMenu()">‚Üê Back</button>
            <div class="header">
                <h1>üõ†Ô∏è Opening Builder</h1>
                <p>Create your own opening repertoire</p>
            </div>

            <div class="tabs">
                <button class="tab active" onclick="switchTab('visual')" id="tabVisual">Visual Builder</button>
                <button class="tab" onclick="switchTab('json')" id="tabJson">JSON</button>
            </div>

            <div id="visualBuilder">
                <div class="builder-section">
                    <h3>Opening Info</h3>
                    <div class="form-group">
                        <label>Name</label>
                        <input type="text" id="openingName" placeholder="e.g., Ruy Lopez">
                    </div>
                    <div class="form-group">
                        <label>Description</label>
                        <input type="text" id="openingDesc" placeholder="e.g., Classical Spanish">
                    </div>
                    <div class="form-group">
                        <label>You Play As</label>
                        <div class="color-toggle">
                            <div class="color-option white selected" onclick="setColor('white')">‚ôî White</div>
                            <div class="color-option black" onclick="setColor('black')">‚ôö Black</div>
                        </div>
                    </div>
                </div>

                <div class="builder-section">
                    <h3>Build Your Lines</h3>
                    
                    <!-- Current Position Display -->
                    <div id="currentPositionDisplay"></div>
                    
                    <!-- Opponent's Responses -->
                    <div id="opponentResponses"></div>
                    
                    <!-- Add Move Section -->
                    <div id="addMoveSection"></div>
                </div>

                <div class="btn-row">
                    <button class="btn btn-secondary" onclick="preview()">üëÅÔ∏è Preview</button>
                    <button class="btn btn-primary" onclick="save()">üíæ Save</button>
                </div>
            </div>

            <div id="jsonBuilder" style="display:none">
                <div class="builder-section">
                    <h3>Import JSON</h3>
                    <textarea class="json-area" id="jsonIn" placeholder="Paste JSON..."></textarea>
                    <div class="btn-row"><button class="btn btn-primary" onclick="importJ()">Import</button></div>
                </div>
                <div class="builder-section">
                    <h3>Export</h3>
                    <textarea class="json-area" id="jsonOut" readonly></textarea>
                    <button class="copy-btn" onclick="copyJ()">üìã Copy</button>
                </div>
            </div>
        </div>
    </div>

<script>
// =====================================================
// DEFAULT OPENINGS DATA
// =====================================================
const DEFAULT_OPENINGS = {
    italian_game: {
        name: "Italian Game",
        color: "white",
        description: "Classic 1.e4 opening targeting f7",
        startingMoves: "1. e4 e5 2. Nf3 Nc6 3. Bc4",
        tree: {
            id: 'root', move: '1. e4', player: 'white', explanation: 'King\'s Pawn opening.',
            children: [
                {
                    id: 'e5', move: '1... e5', player: 'black', label: 'Classical',
                    response: {
                        id: 'Nf3', move: '2. Nf3', player: 'white', explanation: 'Attack e5!',
                        children: [
                            {
                                id: 'Nc6', move: '2... Nc6', player: 'black', label: 'Main Line',
                                response: {
                                    id: 'Bc4', move: '3. Bc4', player: 'white', explanation: 'Italian Game! Target f7.',
                                    children: [
                                        {
                                            id: 'Bc5', move: '3... Bc5', player: 'black', label: 'Giuoco Piano',
                                            response: {
                                                id: 'c3', move: '4. c3', player: 'white', explanation: 'Prepare d4!',
                                                children: [
                                                    {
                                                        id: 'Nf6_gp', move: '4... Nf6', player: 'black', label: 'Main',
                                                        response: {
                                                            id: 'd4', move: '5. d4', player: 'white', explanation: 'Strike center!',
                                                            children: [
                                                                {
                                                                    id: 'exd4', move: '5... exd4', player: 'black', label: 'Main',
                                                                    response: {
                                                                        id: 'cxd4', move: '6. cxd4', player: 'white', explanation: 'Ideal center!',
                                                                        children: [
                                                                            {
                                                                                id: 'Bb4+', move: '6... Bb4+', player: 'black', label: 'Check',
                                                                                response: {
                                                                                    id: 'Nc3', move: '7. Nc3', player: 'white', explanation: 'Greco Attack - gambit e4!',
                                                                                    children: []
                                                                                }
                                                                            }
                                                                        ]
                                                                    }
                                                                }
                                                            ]
                                                        }
                                                    }
                                                ]
                                            }
                                        },
                                        {
                                            id: 'Nf6_tk', move: '3... Nf6', player: 'black', label: 'Two Knights',
                                            response: {
                                                id: 'Ng5', move: '4. Ng5', player: 'white', explanation: 'Fried Liver Attack!',
                                                children: [
                                                    {
                                                        id: 'd5', move: '4... d5', player: 'black', label: 'Main',
                                                        response: {
                                                            id: 'exd5', move: '5. exd5', player: 'white', explanation: 'Critical moment...',
                                                            children: [
                                                                {
                                                                    id: 'Nxd5', move: '5... Nxd5??', player: 'black', label: 'BLUNDER!',
                                                                    response: {
                                                                        id: 'Nxf7', move: '6. Nxf7!', player: 'white', explanation: 'üî• FRIED LIVER!',
                                                                        children: []
                                                                    }
                                                                },
                                                                {
                                                                    id: 'Na5', move: '5... Na5', player: 'black', label: 'Correct',
                                                                    response: {
                                                                        id: 'Bb5+', move: '6. Bb5+', player: 'white', explanation: 'Check! Theory continues.',
                                                                        children: []
                                                                    }
                                                                }
                                                            ]
                                                        }
                                                    }
                                                ]
                                            }
                                        }
                                    ]
                                }
                            }
                        ]
                    }
                },
                {
                    id: 'c5', move: '1... c5', player: 'black', label: 'Sicilian',
                    response: { id: 'Nf3_sic', move: '2. Nf3', player: 'white', explanation: 'Open Sicilian.', children: [] }
                },
                {
                    id: 'e6', move: '1... e6', player: 'black', label: 'French',
                    response: { id: 'd4_fr', move: '2. d4', player: 'white', explanation: 'Build center.', children: [] }
                }
            ]
        }
    },
    london_system: {
        name: "London System",
        color: "white",
        description: "Solid d4 opening with Bf4",
        startingMoves: "1. d4 d5 2. Bf4",
        tree: {
            id: 'root', move: '1. d4', player: 'white', explanation: 'Queen\'s Pawn.',
            children: [
                {
                    id: 'd5', move: '1... d5', player: 'black', label: 'Main',
                    response: {
                        id: 'Bf4', move: '2. Bf4', player: 'white', explanation: 'The London!',
                        children: [
                            {
                                id: 'Nf6', move: '2... Nf6', player: 'black', label: 'Natural',
                                response: {
                                    id: 'e3', move: '3. e3', player: 'white', explanation: 'Solid pyramid.',
                                    children: []
                                }
                            }
                        ]
                    }
                }
            ]
        }
    },
    sicilian_najdorf: {
        name: "Sicilian Najdorf",
        color: "black",
        description: "Fighting defense to 1.e4",
        startingMoves: "1. e4 c5",
        tree: {
            id: 'root', move: '1. e4', player: 'white', explanation: 'White plays e4.',
            children: [
                {
                    id: 'c5', move: '1... c5', player: 'black', label: 'Sicilian!',
                    response: {
                        id: 'Nf3', move: '2. Nf3', player: 'white', explanation: 'Open Sicilian.',
                        children: [
                            {
                                id: 'd6', move: '2... d6', player: 'black', label: 'Main',
                                response: {
                                    id: 'd4', move: '3. d4 cxd4 4. Nxd4', player: 'white', explanation: 'Open Sicilian.',
                                    children: [
                                        {
                                            id: 'Nf6', move: '4... Nf6', player: 'black', label: 'Attack e4',
                                            response: {
                                                id: 'Nc3', move: '5. Nc3', player: 'white', explanation: 'Defend.',
                                                children: [
                                                    {
                                                        id: 'a6', move: '5... a6', player: 'black', label: 'Najdorf!',
                                                        response: {
                                                            id: 'Be3', move: '6. Be3', player: 'white', explanation: 'English Attack.',
                                                            children: []
                                                        }
                                                    }
                                                ]
                                            }
                                        }
                                    ]
                                }
                            }
                        ]
                    }
                }
            ]
        }
    }
};

// =====================================================
// APP STATE
// =====================================================
let OPENINGS = {};
let currentOpening = null;
let currentPath = [];
let userColor = 'white';

// Builder state
let builderColor = 'white';
let builderTree = null;
let builderPath = []; // Path to current position in builder

// =====================================================
// INIT
// =====================================================
function init() {
    OPENINGS = JSON.parse(JSON.stringify(DEFAULT_OPENINGS));
    try {
        const del = JSON.parse(localStorage.getItem('deletedOp') || '[]');
        del.forEach(k => delete OPENINGS[k]);
        const custom = JSON.parse(localStorage.getItem('customOp2') || '{}');
        Object.assign(OPENINGS, custom);
    } catch(e) {}
    renderMenu();
}

function saveStorage() {
    const custom = {};
    for (const [k, v] of Object.entries(OPENINGS)) {
        if (!DEFAULT_OPENINGS[k]) custom[k] = v;
    }
    localStorage.setItem('customOp2', JSON.stringify(custom));
}

// =====================================================
// SCREENS
// =====================================================
function showScreen(id) {
    document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
    document.getElementById(id).classList.add('active');
}

function goToMenu() {
    showScreen('menuScreen');
    renderMenu();
}

// =====================================================
// MENU
// =====================================================
function renderMenu() {
    const c = document.getElementById('openingsContainer');
    const w = Object.entries(OPENINGS).filter(([_, o]) => o.color === 'white');
    const b = Object.entries(OPENINGS).filter(([_, o]) => o.color === 'black');
    let h = '';
    if (w.length) {
        h += '<p class="section-title">Playing as White</p>';
        w.forEach(([k, o]) => { h += card(k, o); });
    }
    if (b.length) {
        h += '<p class="section-title">Playing as Black</p>';
        b.forEach(([k, o]) => { h += card(k, o); });
    }
    c.innerHTML = h;
}

function card(k, o) {
    return `<div class="opening-card" onclick="startTraining('${k}')">
        <h3>${o.name}<span class="color-badge ${o.color}">${o.color[0].toUpperCase() + o.color.slice(1)}</span></h3>
        <p>${o.description}</p>
        <div class="moves">${o.startingMoves}</div>
        <button class="delete-btn" onclick="event.stopPropagation();delOp('${k}')" title="Delete">üóë</button>
    </div>`;
}

function delOp(k) {
    if (!confirm('Delete "' + (OPENINGS[k]?.name || k) + '"?')) return;
    delete OPENINGS[k];
    if (DEFAULT_OPENINGS[k]) {
        let del = JSON.parse(localStorage.getItem('deletedOp') || '[]');
        del.push(k);
        localStorage.setItem('deletedOp', JSON.stringify(del));
    }
    saveStorage();
    renderMenu();
}

// =====================================================
// TRAINER
// =====================================================
function startTraining(k) {
    currentOpening = OPENINGS[k];
    userColor = currentOpening.color;
    currentPath = [];
    showScreen('trainerScreen');
    document.getElementById('openingTitle').textContent = currentOpening.name;
    document.getElementById('openingSubtitle').textContent = 'Playing as ' + userColor[0].toUpperCase() + userColor.slice(1);
    renderTrainer();
}

function getNode() {
    let n = currentOpening.tree;
    for (const id of currentPath) {
        if (n.children) {
            const c = n.children.find(x => x.id === id);
            if (c) n = c.response || c;
        } else if (n.choices) {
            const c = n.choices.find(x => x.id === id);
            if (c) n = c;
        } else if (n.response?.children) {
            const c = n.response.children.find(x => x.id === id);
            if (c) n = c.response || c;
        }
    }
    return n;
}

function getOpts(n) {
    if (n.isChoice && n.choices) return { type: 'choices', opts: n.choices };
    if (n.children?.length) return { type: 'moves', opts: n.children };
    if (n.response?.children?.length) return { type: 'moves', opts: n.response.children };
    return { type: 'end', opts: [] };
}

function getHistory() {
    let h = [{ m: currentOpening.tree.move, p: currentOpening.tree.player }];
    let n = currentOpening.tree;
    for (const id of currentPath) {
        if (n.children) {
            const c = n.children.find(x => x.id === id);
            if (c) {
                h.push({ m: c.move, p: c.player });
                if (c.response) {
                    h.push({ m: c.response.move, p: c.response.player, ch: c.response.isChoice });
                    n = c.response;
                }
            }
        } else if (n.choices) {
            const c = n.choices.find(x => x.id === id);
            if (c) { h.push({ m: c.move, p: userColor, ch: true }); n = c; }
        } else if (n.response?.children) {
            const c = n.response.children.find(x => x.id === id);
            if (c) {
                h.push({ m: c.move, p: c.player });
                if (c.response) { h.push({ m: c.response.move, p: c.response.player }); n = c.response; }
            }
        }
    }
    return h;
}

function renderTrainer() {
    const n = getNode(), o = getOpts(n), h = getHistory(), mc = Math.ceil(h.length / 2);
    document.getElementById('moveHistory').innerHTML = h.map(x => 
        `<span class="move-tag ${x.p === 'white' ? 'white-move' : 'black-move'} ${x.ch ? 'choice' : ''}">${x.m}</span>`
    ).join('');
    
    const isU = n.player === userColor;
    let html = `<div class="move-label"><div class="move-dot ${isU ? 'your-move' : 'opponent-move'}"></div>
        <span class="${isU ? 'your-move' : 'opponent-move'}">${isU ? 'Your Move' : 'Opponent'}</span></div>
        <div class="current-move ${isU ? '' : 'opponent'}"><h2>${n.move}</h2></div>
        <p class="explanation">${n.explanation || ''}</p>`;
    
    if (o.type === 'moves') {
        html += `<div class="options-section"><div class="options-label"><div class="move-dot opponent-move"></div>
            <span>${userColor === 'white' ? 'Black' : 'White'} might play...</span></div>`;
        o.opts.forEach(x => {
            const lbl = x.label?.includes('BLUNDER') ? 'blunder' : (x.label === 'Main' || x.label === 'Main Line') ? 'main' : '';
            html += `<button class="option-btn" onclick="sel('${x.id}')">
                <span class="move-text">${x.move}</span>
                ${x.label ? `<span class="label ${lbl}">${x.label}</span>` : ''}
                <span class="arrow">‚Üí</span></button>`;
        });
        html += '</div>';
    } else if (o.type === 'choices') {
        html += `<div class="options-section"><div class="options-label"><div class="move-dot your-move"></div><span>Choose:</span></div><div class="choices-grid">`;
        o.opts.forEach(c => {
            html += `<button class="choice-card ${c.color || 'blue'}" onclick="sel('${c.id}')">
                <h4>${c.move}</h4><p class="name">${c.name || ''}</p><p class="style">${c.style || ''}</p></button>`;
        });
        html += '</div></div>';
    } else {
        html += `<div class="end-card"><div class="icon">üéØ</div><h3>End of Line</h3><p>Move ${mc}</p></div>`;
    }
    
    document.getElementById('currentMoveCard').innerHTML = html;
    document.getElementById('controls').innerHTML = currentPath.length ? 
        `<button class="control-btn secondary" onclick="back()">‚Üê Back</button>
         <button class="control-btn secondary" onclick="reset()">Start Over</button>` : '';
    document.getElementById('progressDots').innerHTML = Array.from({length: 12}, (_, i) => 
        `<div class="progress-dot ${i < mc ? 'active' : ''}"></div>`).join('');
}

function sel(id) { currentPath.push(id); renderTrainer(); }
function back() { currentPath.pop(); renderTrainer(); }
function reset() { currentPath = []; renderTrainer(); }

// =====================================================
// BUILDER
// =====================================================
function showBuilder() {
    builderColor = 'white';
    builderPath = [];
    builderTree = null;
    document.getElementById('openingName').value = '';
    document.getElementById('openingDesc').value = '';
    updateColorToggle();
    renderBuilder();
    switchTab('visual');
    showScreen('builderScreen');
}

function switchTab(t) {
    document.getElementById('tabVisual').classList.toggle('active', t === 'visual');
    document.getElementById('tabJson').classList.toggle('active', t === 'json');
    document.getElementById('visualBuilder').style.display = t === 'visual' ? 'block' : 'none';
    document.getElementById('jsonBuilder').style.display = t === 'json' ? 'block' : 'none';
    if (t === 'json') document.getElementById('jsonOut').value = JSON.stringify(buildOpeningObj(), null, 2);
}

function setColor(c) {
    builderColor = c;
    updateColorToggle();
    // Reset tree when color changes
    builderTree = null;
    builderPath = [];
    renderBuilder();
}

function updateColorToggle() {
    document.querySelectorAll('.color-option').forEach(el => 
        el.classList.toggle('selected', el.classList.contains(builderColor)));
}

// Get current node in builder tree based on path
function getBuilderNode() {
    if (!builderTree) return null;
    let node = builderTree;
    for (let i = 0; i < builderPath.length; i++) {
        const id = builderPath[i];
        if (node.children) {
            const child = node.children.find(c => c.id === id);
            if (child && child.response) {
                node = child.response;
            } else if (child) {
                node = child;
            } else {
                return null;
            }
        } else {
            return null;
        }
    }
    return node;
}

// Navigate to a position
function builderNavigate(pathIndex) {
    builderPath = builderPath.slice(0, pathIndex);
    renderBuilder();
}

// Navigate into a child
function builderGoTo(childId) {
    builderPath.push(childId);
    renderBuilder();
}

// Get the breadcrumb path for display
function getBuilderBreadcrumbs() {
    if (!builderTree) return [];
    let crumbs = [{ move: builderTree.move, index: -1 }];
    let node = builderTree;
    for (let i = 0; i < builderPath.length; i++) {
        const id = builderPath[i];
        if (node.children) {
            const child = node.children.find(c => c.id === id);
            if (child) {
                crumbs.push({ move: child.move, index: i });
                if (child.response) {
                    crumbs.push({ move: child.response.move, index: i });
                    node = child.response;
                }
            }
        }
    }
    return crumbs;
}

function renderBuilder() {
    const posDisplay = document.getElementById('currentPositionDisplay');
    const respDisplay = document.getElementById('opponentResponses');
    const addSection = document.getElementById('addMoveSection');
    
    // No tree yet - show initial state
    if (!builderTree) {
        const firstPlayer = builderColor;
        const moveNum = '1.';
        const placeholder = firstPlayer === 'white' ? 'e.g., e4 or d4' : 'Waiting for White...';
        
        posDisplay.innerHTML = `
            <div class="empty-state">
                <div class="icon">‚ôüÔ∏è</div>
                <p>Start building your opening</p>
            </div>`;
        
        respDisplay.innerHTML = '';
        
        if (builderColor === 'white') {
            addSection.innerHTML = `
                <div class="add-section">
                    <div class="add-section-title">Your First Move (White)</div>
                    <div class="add-row">
                        <input type="text" id="newMove" placeholder="e.g., e4">
                        <input type="text" id="newExpl" class="expl-input" placeholder="Explanation">
                        <button onclick="addFirstMove()">Add</button>
                    </div>
                </div>`;
        } else {
            addSection.innerHTML = `
                <div class="add-section">
                    <div class="add-section-title">White's First Move (Opponent)</div>
                    <div class="add-row">
                        <input type="text" id="newMove" placeholder="e.g., e4">
                        <button onclick="addFirstMoveBlack()">Add</button>
                    </div>
                </div>`;
        }
        
        setupEnterKey();
        return;
    }
    
    const currentNode = getBuilderNode();
    const crumbs = getBuilderBreadcrumbs();
    const isYourMove = currentNode.player === builderColor;
    const opponentColor = builderColor === 'white' ? 'Black' : 'White';
    
    // Current position display with breadcrumbs
    let pathHtml = '<div class="path-display">';
    crumbs.forEach((c, i) => {
        const isLast = i === crumbs.length - 1;
        const clickable = !isLast && c.index >= -1;
        if (clickable) {
            pathHtml += `<span class="path-crumb" onclick="builderNavigate(${c.index + 1})" style="cursor:pointer">${c.move}</span>`;
        } else {
            pathHtml += `<span class="path-crumb current">${c.move}</span>`;
        }
        if (!isLast) pathHtml += '<span class="path-sep">‚Üí</span>';
    });
    pathHtml += '</div>';
    
    posDisplay.innerHTML = pathHtml + `
        <div class="current-position">
            <div class="current-position-label">${isYourMove ? 'Your Move' : 'Opponent\'s Move'}</div>
            <div class="current-position-move">${currentNode.move}</div>
            ${currentNode.explanation ? `<div class="current-position-expl">${currentNode.explanation}</div>` : ''}
        </div>`;
    
    // Show opponent's responses (children) if this is your move
    if (isYourMove && currentNode.children && currentNode.children.length > 0) {
        let respHtml = `<div class="opponent-responses">
            <div class="opponent-responses-title">${opponentColor}'s possible responses:</div>`;
        currentNode.children.forEach(child => {
            const hasDepth = child.response && child.response.children && child.response.children.length > 0;
            respHtml += `
                <div class="response-item" onclick="builderGoTo('${child.id}')">
                    <span class="notation">${child.move}</span>
                    ${child.label ? `<span class="label-tag">${child.label}</span>` : ''}
                    ${hasDepth ? '<span class="branch-count">has lines</span>' : ''}
                    <span class="arrow">‚Üí</span>
                    <button class="del" onclick="event.stopPropagation();deleteChild('${child.id}')" title="Delete">√ó</button>
                </div>`;
        });
        respHtml += '</div>';
        respDisplay.innerHTML = respHtml;
    } else {
        respDisplay.innerHTML = '';
    }
    
    // Add move section
    if (isYourMove) {
        // Can add opponent responses
        addSection.innerHTML = `
            <div class="add-section">
                <div class="add-section-title">Add ${opponentColor}'s Response</div>
                <div class="add-row">
                    <input type="text" id="newMove" placeholder="e.g., e5">
                    <input type="text" id="newLabel" class="label-input" placeholder="Label">
                    <button onclick="addOpponentMove()">Add</button>
                </div>
                <p class="help">Add different moves ${opponentColor} might play</p>
            </div>`;
    } else {
        // Need to add your response, then can continue
        if (!currentNode.response) {
            addSection.innerHTML = `
                <div class="add-section">
                    <div class="add-section-title">Your Response</div>
                    <div class="add-row">
                        <input type="text" id="newMove" placeholder="Your move">
                        <input type="text" id="newExpl" class="expl-input" placeholder="Explanation">
                        <button onclick="addYourResponse()">Add</button>
                    </div>
                </div>`;
        } else {
            // Already has response, show it and navigate there
            addSection.innerHTML = `
                <div class="add-section">
                    <div class="add-section-title">Your Response</div>
                    <div class="response-item" onclick="goToResponse()">
                        <span class="notation" style="color:#fbbf24">${currentNode.response.move}</span>
                        <span class="arrow">‚Üí</span>
                    </div>
                    <p class="help">Click to continue building from your response</p>
                </div>`;
        }
    }
    
    setupEnterKey();
}

function setupEnterKey() {
    setTimeout(() => {
        const input = document.getElementById('newMove');
        if (input) {
            input.addEventListener('keypress', e => {
                if (e.key === 'Enter') {
                    // Find and click the add button
                    const btn = input.parentElement.querySelector('button');
                    if (btn) btn.click();
                }
            });
            input.focus();
        }
    }, 50);
}

function addFirstMove() {
    const move = document.getElementById('newMove').value.trim();
    if (!move) return;
    const expl = document.getElementById('newExpl')?.value.trim() || '';
    
    builderTree = {
        id: 'root',
        move: '1. ' + move,
        player: 'white',
        explanation: expl,
        children: []
    };
    
    renderBuilder();
}

function addFirstMoveBlack() {
    const move = document.getElementById('newMove').value.trim();
    if (!move) return;
    
    builderTree = {
        id: 'root',
        move: '1. ' + move,
        player: 'white',
        explanation: 'Opponent\'s move.',
        children: []
    };
    
    renderBuilder();
}

function addOpponentMove() {
    const move = document.getElementById('newMove').value.trim();
    if (!move) return;
    const label = document.getElementById('newLabel')?.value.trim() || '';
    
    const currentNode = getBuilderNode();
    if (!currentNode) return;
    
    // Calculate move number
    const crumbs = getBuilderBreadcrumbs();
    const moveCount = Math.ceil(crumbs.length / 2);
    const isBlackMove = currentNode.player === 'white';
    const notation = isBlackMove ? `${moveCount}... ${move}` : `${moveCount + 1}. ${move}`;
    
    const newChild = {
        id: 'n' + Date.now() + Math.random().toString(36).substr(2, 5),
        move: notation,
        player: isBlackMove ? 'black' : 'white',
        label: label,
        response: null
    };
    
    if (!currentNode.children) currentNode.children = [];
    currentNode.children.push(newChild);
    
    // Navigate to this new child
    builderPath.push(newChild.id);
    renderBuilder();
}

function addYourResponse() {
    const move = document.getElementById('newMove').value.trim();
    if (!move) return;
    const expl = document.getElementById('newExpl')?.value.trim() || '';
    
    const currentNode = getBuilderNode();
    if (!currentNode) return;
    
    // Find the child node we're responding to
    // We're at the opponent's move, need to find it in parent's children
    let parentNode = builderTree;
    let childNode = null;
    
    if (builderPath.length === 0) {
        // We're at root, which shouldn't happen for addYourResponse
        return;
    }
    
    // Navigate to parent
    for (let i = 0; i < builderPath.length - 1; i++) {
        const id = builderPath[i];
        if (parentNode.children) {
            const child = parentNode.children.find(c => c.id === id);
            if (child && child.response) {
                parentNode = child.response;
            }
        }
    }
    
    // Find current child
    const currentId = builderPath[builderPath.length - 1];
    if (parentNode.children) {
        childNode = parentNode.children.find(c => c.id === currentId);
    }
    
    if (!childNode) return;
    
    // Calculate move number
    const crumbs = getBuilderBreadcrumbs();
    const moveCount = Math.ceil((crumbs.length + 1) / 2);
    const isWhiteMove = builderColor === 'white';
    const notation = isWhiteMove ? `${moveCount}. ${move}` : `${moveCount}... ${move}`;
    
    childNode.response = {
        id: 'r' + Date.now(),
        move: notation,
        player: builderColor,
        explanation: expl,
        children: []
    };
    
    renderBuilder();
}

function goToResponse() {
    // The current path already points to opponent's move
    // We just need to re-render to show we're now at our response
    renderBuilder();
}

function deleteChild(childId) {
    const currentNode = getBuilderNode();
    if (!currentNode || !currentNode.children) return;
    
    const idx = currentNode.children.findIndex(c => c.id === childId);
    if (idx > -1) {
        currentNode.children.splice(idx, 1);
        renderBuilder();
    }
}

function buildOpeningObj() {
    const name = document.getElementById('openingName').value.trim() || 'My Opening';
    const desc = document.getElementById('openingDesc').value.trim() || '';
    
    // Generate starting moves from tree
    let startingMoves = '';
    if (builderTree) {
        let node = builderTree;
        let moves = [node.move];
        while (node.children && node.children.length > 0) {
            const child = node.children[0];
            moves.push(child.move);
            if (child.response) {
                moves.push(child.response.move);
                node = child.response;
            } else {
                break;
            }
            if (moves.length >= 6) break;
        }
        startingMoves = moves.join(' ');
    }
    
    return {
        name: name,
        color: builderColor,
        description: desc,
        startingMoves: startingMoves || '1. e4',
        tree: builderTree || { id: 'root', move: '1. e4', player: 'white', explanation: '', children: [] }
    };
}

function preview() {
    if (!builderTree) {
        alert('Add at least one move first');
        return;
    }
    OPENINGS['_preview'] = buildOpeningObj();
    startTraining('_preview');
}

function save() {
    const name = document.getElementById('openingName').value.trim();
    if (!name) { alert('Enter a name'); return; }
    if (!builderTree) { alert('Add at least one move'); return; }
    
    const key = name.toLowerCase().replace(/[^a-z0-9]/g, '_') + '_' + Date.now();
    OPENINGS[key] = buildOpeningObj();
    saveStorage();
    alert('"' + name + '" saved!');
    goToMenu();
}

function copyJ() {
    navigator.clipboard.writeText(document.getElementById('jsonOut').value);
    alert('Copied!');
}

function importJ() {
    try {
        const o = JSON.parse(document.getElementById('jsonIn').value);
        if (!o.name || !o.tree) { alert('Invalid JSON'); return; }
        const key = o.name.toLowerCase().replace(/[^a-z0-9]/g, '_') + '_' + Date.now();
        OPENINGS[key] = o;
        saveStorage();
        alert('"' + o.name + '" imported!');
        goToMenu();
    } catch(e) { alert('Invalid JSON: ' + e.message); }
}

document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>
